<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <link rel="icon" type="image/png" href="user_retro_brawl_resized_36x36.png">
  <meta name="viewport" ...>
  <title>RETRO BRAWL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
:root{
  --gold:#ffdd00;--red:#ff2244;--orange:#ff6600;
  --blue:#0099ff;--dark:#08011a;--panel:#0d0222;
  --border:#ff4400;--tc:#ffd700;--green:#00cc55;--purple:#aa44ff;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:var(--dark);display:flex;flex-direction:column;align-items:center;
  justify-content:center;min-height:100vh;overflow:hidden;
  font-family:'Press Start 2P',monospace;touch-action:none;}
.screen{display:none;width:640px;max-width:100vw;flex-direction:column;
  align-items:center;background:var(--panel);border:3px solid var(--border);}
.screen.active{display:flex;}
.scr-body{width:100%;display:flex;flex-direction:column;align-items:center;
  gap:12px;padding:20px;overflow-y:auto;max-height:96vh;}
.sep{width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--border),transparent);}
.big-title{font-size:22px;color:var(--gold);text-align:center;
  text-shadow:4px 4px 0 #880000;animation:glow 2s ease-in-out infinite;letter-spacing:2px;}
.sub-title{font-size:8px;color:var(--orange);letter-spacing:2px;text-align:center;}
.scr-title{font-size:11px;color:var(--gold);text-align:center;}
.stars{font-size:9px;color:var(--red);letter-spacing:4px;}
.back-btn{align-self:flex-start;background:transparent;color:#555;border:2px solid #333;
  font-family:'Press Start 2P',monospace;font-size:6px;padding:7px 11px;cursor:pointer;}
.back-btn:hover{color:#888;border-color:#555;}
.user-bar{display:flex;justify-content:space-between;align-items:center;
  background:#0a0010;border:2px solid #331100;padding:8px 12px;width:100%;}
.user-name{font-size:7px;color:var(--gold);}
.user-tc{font-size:7px;color:var(--tc);}
.msg-line{font-size:6px;text-align:center;min-height:14px;}
.msg-ok{color:var(--green);}
.msg-err{color:var(--red);}
.gbtn{background:var(--gold);color:#000;border:none;
  font-family:'Press Start 2P',monospace;font-size:9px;
  padding:13px 24px;cursor:pointer;box-shadow:4px 4px 0 #996600;width:100%;}
.gbtn:hover{transform:translate(2px,2px);box-shadow:2px 2px 0 #996600;}
.gbtn:active{transform:translate(4px,4px);box-shadow:none;}
.gbtn.sm{font-size:7px;padding:10px 14px;width:auto;}
.gbtn.red{background:var(--red);box-shadow:4px 4px 0 #880011;}
.gbtn.blue{background:var(--blue);box-shadow:4px 4px 0 #004488;}
.gbtn.ghost{background:transparent;color:#777;border:2px solid #444;box-shadow:none;font-size:7px;padding:9px;}
.gbtn.ghost:hover{color:#aaa;border-color:#666;transform:none;}
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;}
.mbtn{background:#0a0a1a;border:3px solid #333;color:#fff;
  font-family:'Press Start 2P',monospace;font-size:8px;
  padding:14px 8px;cursor:pointer;text-align:center;box-shadow:3px 3px 0 #000;}
.mbtn:hover{transform:translate(2px,2px);box-shadow:1px 1px 0 #000;}
.mbtn.gold{border-color:var(--gold);color:var(--gold);}
.mbtn.blue{border-color:var(--blue);color:var(--blue);}
.mbtn.orange{border-color:var(--orange);color:var(--orange);}
.mbtn.green{border-color:var(--green);color:var(--green);}
.mbtn.purple{border-color:var(--purple);color:var(--purple);}
.mbtn.red{border-color:var(--red);color:var(--red);}
.mbtn.full{grid-column:1/-1;}
.auth-tabs{display:flex;width:100%;max-width:340px;}
.auth-tab{flex:1;padding:10px;font-family:'Press Start 2P',monospace;font-size:8px;
  background:#111;color:#555;border:2px solid #333;cursor:pointer;text-align:center;}
.auth-tab.active{background:var(--border);color:#fff;border-color:var(--border);}
.auth-form{display:flex;flex-direction:column;gap:10px;width:100%;max-width:340px;}
.auth-form input,.text-input{background:#0a0a1a;border:2px solid #333;color:#fff;
  font-family:'Press Start 2P',monospace;font-size:8px;padding:12px 10px;outline:none;width:100%;}
.auth-form input:focus,.text-input:focus{border-color:var(--gold);}
.auth-form input::placeholder,.text-input::placeholder{color:#444;}
.item-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;}
.item-card{background:#0a0010;border:3px solid #2a0030;padding:10px 6px;
  cursor:pointer;text-align:center;display:flex;flex-direction:column;align-items:center;gap:5px;position:relative;}
.item-card:hover{border-color:var(--gold);}
.item-card.equipped{border-color:var(--gold);background:#1a1000;}
.item-card.owned{border-color:#336600;}
.item-card.equipped::after{content:'ON';position:absolute;top:3px;right:4px;font-size:5px;color:var(--gold);}
.item-card canvas{image-rendering:pixelated;}
.item-name{font-size:5px;color:#ccc;}
.item-price{font-size:5px;color:var(--tc);}
.inv-tabs{display:flex;gap:0;width:100%;}
.inv-tab{flex:1;padding:8px 4px;font-family:'Press Start 2P',monospace;font-size:6px;
  background:#111;color:#555;border:2px solid #333;cursor:pointer;text-align:center;}
.inv-tab.active{background:#1a0a00;color:var(--gold);border-color:var(--orange);}
.inv-empty{font-size:7px;color:#444;text-align:center;padding:20px;}
.inv-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;width:100%;}
.stat-box{background:#0a0010;border:2px solid #2a0030;padding:10px;text-align:center;}
.stat-val{font-size:14px;color:var(--gold);display:block;margin-bottom:4px;}
.stat-lbl{font-size:5px;color:#666;}
/* GLOVE CUSTOMIZER */
.glove-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;width:100%;}
.glove-card{background:#0a0010;border:3px solid #2a0030;padding:8px 4px;
  cursor:pointer;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;}
.glove-card:hover{border-color:var(--gold);}
.glove-card.equipped{border-color:var(--gold);background:#1a1000;}
.glove-card.equipped::after{content:'ON';position:absolute;top:2px;right:3px;font-size:5px;color:var(--gold);}
.glove-card{position:relative;}
/* Online */
.room-code{font-size:32px;color:var(--green);text-align:center;letter-spacing:6px;text-shadow:0 0 20px var(--green);}
.room-input{font-size:20px;text-align:center;letter-spacing:6px;background:#0a0a1a;border:3px solid var(--green);
  color:var(--green);font-family:'Press Start 2P',monospace;padding:14px;outline:none;width:100%;max-width:280px;}
.lobby-player{display:flex;align-items:center;gap:10px;background:#0a0010;border:2px solid #2a0030;padding:8px 12px;width:100%;}
.lobby-dot{width:10px;height:10px;border-radius:50%;}
.lobby-dot.ready{background:var(--green);box-shadow:0 0 8px var(--green);}
.lobby-dot.waiting{background:#444;animation:blink 1s steps(1) infinite;}
.ping-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 1.5s ease-in-out infinite;}
.online-badge{font-size:6px;color:var(--green);background:#001a00;border:1px solid var(--green);padding:3px 6px;text-align:center;}
/* GAME */
#gameWrapper{position:relative;width:640px;max-width:100vw;flex-direction:column;display:none;}
#gameWrapper.active{display:flex;}
#hud{background:#000;border:3px solid var(--border);border-bottom:none;padding:7px 10px;display:flex;justify-content:space-between;align-items:center;gap:6px;}
.fhud{flex:1;}
.fname{font-size:6px;color:var(--gold);margin-bottom:3px;}
.hbg{height:13px;background:#1a0010;border:2px solid #440022;overflow:hidden;}
.hfill{height:100%;transition:width 0.1s steps(8);}
#hf1{background:linear-gradient(90deg,#ff0044,#ff6600);}
#hf2{background:linear-gradient(90deg,#0099ff,#00ddff);float:right;}
.hud-mid{text-align:center;min-width:110px;}
#rndTxt{font-size:5px;color:#aaa;display:block;}
#tmr{font-size:20px;color:var(--gold);text-shadow:0 0 10px #ffaa00;display:block;}
#hudScr{font-size:6px;color:#fff;display:block;margin-top:1px;}
#hudTC{font-size:5px;color:var(--tc);display:block;}
#gameCanvas{display:block;border:3px solid var(--border);border-bottom:none;cursor:crosshair;}
#mobileUI{background:#000;border:3px solid var(--border);padding:7px 8px;display:flex;align-items:center;justify-content:space-between;gap:5px;}
.dpad{display:grid;grid-template-columns:38px 38px 38px;grid-template-rows:34px 34px;gap:3px;}
.dp{background:#111;border:2px solid #333;color:#bbb;font-family:'Press Start 2P',monospace;font-size:11px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;-webkit-user-select:none;box-shadow:2px 2px 0 #000;}
.dp:active,.dp.on{transform:translate(1px,1px);box-shadow:none;background:#1a1a1a;}
.dp.blank{background:none!important;border:none!important;box-shadow:none!important;pointer-events:none;}
.act-btns{display:flex;flex-direction:column;gap:4px;}
.act-row{display:flex;gap:4px;}
.abtn{background:#0a0a1a;border:3px solid #444;color:#fff;font-family:'Press Start 2P',monospace;font-size:5px;
  padding:7px 4px;cursor:pointer;text-align:center;min-width:62px;line-height:1.9;box-shadow:2px 2px 0 #000;
  user-select:none;-webkit-user-select:none;}
.abtn:active,.abtn.on{transform:translate(1px,1px);box-shadow:none;}
.abtn.jbtn{border-color:var(--gold);color:var(--gold);}
.abtn.hbtn{border-color:var(--red);color:var(--red);}
.abtn.bbtn{border-color:var(--blue);color:var(--blue);}
.abtn.menubtn{border-color:#555;color:#555;min-width:44px;font-size:5px;}
#gameOverlay{position:absolute;top:0;left:0;right:0;bottom:0;
  display:none;flex-direction:column;align-items:center;justify-content:center;z-index:200;gap:14px;background:rgba(4,0,18,0.94);}
#gameOverlay.show{display:flex;}
.go-title{font-size:18px;color:var(--gold);text-align:center;text-shadow:3px 3px 0 #880000;white-space:pre;line-height:1.9;}
#hitFlash{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:290;opacity:0;transition:opacity 0.05s;}
#gameWrapper::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:300;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.1) 3px,rgba(0,0,0,0.1) 4px);}
/* CELEBRATION */
#celebrationOverlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:250;display:none;}
#celebrationOverlay.show{display:block;}
@keyframes glow{0%,100%{text-shadow:4px 4px 0 #880000,0 0 20px #ffaa00;}50%{text-shadow:4px 4px 0 #880000,0 0 55px #ffdd00;}}
@keyframes blink{50%{opacity:0;}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1;}100%{transform:translateY(400px) rotate(720deg);opacity:0;}}
.confetti-piece{position:absolute;width:8px;height:8px;animation:confettiFall 1.5s ease-in forwards;}
</style>
</head>
<body>

<!-- AUTH -->
<div class="screen active" id="authScreen">
  <div class="scr-body" style="justify-content:center;min-height:420px;">
    <div class="big-title">RETRO BRAWL</div>
    <div class="stars">&#9733; &#9733; &#9733; &#9733; &#9733;</div>
    <div class="sub-title">CHAMPIONSHIP EDITION</div>
    <div class="sep"></div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="G.switchTab('login')">LOGIN</button>
      <button class="auth-tab" id="tabSignup" onclick="G.switchTab('signup')">SIGN UP</button>
    </div>
    <div class="auth-form" id="loginForm">
      <input type="email" id="loginEmail" placeholder="EMAIL" autocomplete="email">
      <input type="password" id="loginPass" placeholder="PASSWORD" autocomplete="current-password">
      <div class="msg-line msg-err" id="loginErr"></div>
      <button class="gbtn" id="loginBtn">ENTER THE RING</button>
    </div>
    <div class="auth-form" id="signupForm" style="display:none;">
      <input type="text" id="signupName" placeholder="FIGHTER NAME (max 10)" maxlength="10" autocomplete="off">
      <input type="email" id="signupEmail" placeholder="EMAIL" autocomplete="email">
      <input type="password" id="signupPass" placeholder="PASSWORD (min 6)" autocomplete="new-password">
      <div class="msg-line msg-err" id="signupErr"></div>
      <button class="gbtn" id="signupBtn">CREATE FIGHTER</button>
    </div>
    <button class="gbtn ghost" id="guestBtn">PLAY AS GUEST</button>
  </div>
</div>

<!-- MAIN MENU -->
<div class="screen" id="menuScreen">
  <div class="scr-body">
    <div class="big-title">RETRO BRAWL</div>
    <div class="stars">&#9733; &#9733; &#9733; &#9733; &#9733;</div>
    <div class="user-bar">
      <span class="user-name" id="menuName">FIGHTER</span>
      <span class="user-tc" id="menuTC">&#9670; 0 TC</span>
    </div>
    <div class="sep"></div>
    <div class="menu-grid">
      <button class="mbtn gold full" onclick="G.goToGame()">&#9654; VS CPU</button>
      <button class="mbtn green full" onclick="G.showOnlineLobby()">&#127760; 2P ONLINE</button>
      <button class="mbtn blue" onclick="G.showScreen('inventoryScreen');G.renderInventory()">&#127381; INVENTORY</button>
      <button class="mbtn orange" onclick="G.showScreen('shopScreen');G.renderShop()">&#128722; SHOP</button>
      <button class="mbtn purple" onclick="G.showScreen('nameScreen')">&#9998; NAME</button>
      <button class="mbtn red" onclick="G.doLogout()">&#8592; LOGOUT</button>
    </div>
    <button onclick="G.startTutorial()" style="width:100%;margin-top:4px;padding:12px;background:#001a14;border:2px solid #00ffcc;color:#00ffcc;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;letter-spacing:1px;">&#127891; TUTORIAL - EARN 500 TC</button>
    <div style="font-size:5px;color:#333;text-align:center;">M1/1=JAB &nbsp; M2/2=HEAVY &nbsp; SPC/F=BLOCK &nbsp; A/D=MOVE</div>
  </div>
</div>

<!-- NAME SCREEN -->
<div class="screen" id="nameScreen">
  <div class="scr-body">
    <button class="back-btn" onclick="G.showScreen('menuScreen')">&#8592; BACK</button>
    <div class="scr-title">FIGHTER NAME</div>
    <div class="sep"></div>
    <input class="text-input" id="nameInput" maxlength="10" placeholder="YOUR NAME" autocomplete="off"
      style="font-size:14px;text-align:center;border-color:var(--gold);color:var(--gold);letter-spacing:2px;">
    <div style="font-size:6px;color:#555;">MAX 10 CHARACTERS</div>
    <button class="gbtn" style="max-width:260px;" onclick="G.saveName()">SAVE NAME</button>
    <div class="msg-line" id="nameMsg"></div>
  </div>
</div>

<!-- SHOP -->
<div class="screen" id="shopScreen">
  <div class="scr-body">
    <button class="back-btn" onclick="G.showScreen('menuScreen')">&#8592; BACK</button>
    <div class="scr-title">GEAR SHOP</div>
    <div style="font-size:7px;color:var(--tc);" id="shopTC">&#9670; 0 TC</div>
    <div class="sep"></div>
    <div style="font-size:7px;color:var(--gold);width:100%;">&#9651; SHORTS</div>
    <div class="item-grid" id="shopGrid"></div>
    <div class="sep"></div>
    <div style="font-size:7px;color:var(--gold);width:100%;">&#9650; GLOVES</div>
    <div class="glove-grid" id="shopGloveGrid"></div>
    <div class="msg-line" id="shopMsg"></div>
  </div>
</div>

<!-- INVENTORY -->
<div class="screen" id="inventoryScreen">
  <div class="scr-body">
    <button class="back-btn" onclick="G.showScreen('menuScreen')">&#8592; BACK</button>
    <div class="scr-title">INVENTORY</div>
    <div style="font-size:7px;color:var(--tc);" id="invTC">&#9670; 0 TC</div>
    <div class="sep"></div>
    <div class="inv-tabs">
      <button class="inv-tab active" id="invTabShorts" onclick="G.switchInvTab('shorts')">SHORTS</button>
      <button class="inv-tab" id="invTabGloves" onclick="G.switchInvTab('gloves')">GLOVES</button>
      <button class="inv-tab" id="invTabStats" onclick="G.switchInvTab('stats')">STATS</button>
      <button class="inv-tab" id="invTabHistory" onclick="G.switchInvTab('history')">HISTORY</button>
    </div>
    <div id="invShorts" style="width:100%;"><div class="item-grid" id="invGrid"></div></div>
    <div id="invGloves" style="display:none;width:100%;"><div class="glove-grid" id="invGloveGrid"></div></div>
    <div id="invStats" style="display:none;width:100%;"><div class="inv-stats" id="statsGrid"></div></div>
    <div id="invHistory" style="display:none;width:100%;"><div id="historyList" style="display:flex;flex-direction:column;gap:6px;"></div></div>
    <div class="msg-line" id="invMsg"></div>
  </div>
</div>

<!-- ONLINE LOBBY -->
<div class="screen" id="onlineScreen">
  <div class="scr-body">
    <button class="back-btn" onclick="G.leaveOnline()">&#8592; BACK</button>
    <div class="scr-title">2P ONLINE</div>
    <div class="sep"></div>
    <div id="lobbyModeSelect" style="width:100%;display:flex;flex-direction:column;gap:10px;align-items:center;">
      <div style="font-size:7px;color:#aaa;text-align:center;line-height:2.2;">CREATE A ROOM AND SHARE<br>THE CODE WITH YOUR FRIEND</div>
      <button class="gbtn" onclick="G.createRoom()">CREATE ROOM</button>
      <div class="sep"></div>
      <div style="font-size:7px;color:#aaa;">OR JOIN WITH A CODE:</div>
      <input class="room-input" id="joinCodeInput" maxlength="6" placeholder="ENTER CODE" autocomplete="off"
        oninput="this.value=this.value.toUpperCase()">
      <button class="gbtn blue" onclick="G.joinRoom()">JOIN ROOM</button>
      <div class="msg-line msg-err" id="lobbyErr"></div>
    </div>
    <div id="lobbyWaiting" style="display:none;width:100%;flex-direction:column;align-items:center;gap:12px;">
      <div style="font-size:7px;color:#aaa;">ROOM CODE</div>
      <div class="room-code" id="roomCodeDisplay">------</div>
      <div style="font-size:6px;color:#555;">SHARE THIS CODE WITH YOUR OPPONENT</div>
      <div class="sep"></div>
      <div class="lobby-player">
        <div class="lobby-dot ready"></div>
        <span style="font-size:7px;color:#ccc;" id="lobbyP1Name">YOU</span>
        <span style="font-size:7px;color:#444;margin-left:auto;">P1 - RED</span>
      </div>
      <div class="lobby-player">
        <div class="lobby-dot waiting" id="lobbyP2Dot"></div>
        <span style="font-size:7px;color:#ccc;" id="lobbyP2Name">WAITING...</span>
        <span style="font-size:7px;color:#444;margin-left:auto;">P2 - BLUE</span>
      </div>
      <div style="font-size:8px;color:#aaa;text-align:center;line-height:2;" id="lobbyStatus">WAITING FOR OPPONENT...</div>
      <button class="gbtn red" onclick="G.leaveOnline()" style="max-width:200px;">CANCEL</button>
    </div>
  </div>
</div>


<!-- TUTORIAL OVERLAY (shown over game canvas) -->
<div id="tutOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:400;
  flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
  <div id="tutBox" style="background:rgba(4,0,18,0.96);border:3px solid #00ffcc;
    box-shadow:0 0 40px rgba(0,255,204,0.35),inset 0 0 20px rgba(0,255,204,0.04);
    padding:24px 28px;max-width:420px;width:90%;text-align:center;pointer-events:all;
    transform:translateY(-30px);">
    <div style="font-family:'Press Start 2P',monospace;font-size:6px;color:#00ffcc;opacity:0.6;margin-bottom:8px;letter-spacing:2px;">TUTORIAL</div>
    <div class="sep" style="margin-bottom:12px;"></div>
    <div id="tutMsg" style="font-family:'Press Start 2P',monospace;font-size:8px;color:#00ffcc;line-height:2.4;margin-bottom:14px;white-space:pre-line;"></div>
    <div id="tutHint" style="font-family:'Press Start 2P',monospace;font-size:6px;color:#ffdd00;margin-bottom:12px;min-height:14px;line-height:2;"></div>
    <button id="tutNextBtn" class="gbtn sm" style="background:#00ffcc;color:#000;display:none;width:100%;max-width:200px;" onclick="G.tutNext()">NEXT &#9654;</button>
  </div>
</div>

<!-- GAME -->
<div id="gameWrapper">
  <div id="hud">
    <div class="fhud">
      <div class="fname" id="p1HudName">SLUGGER</div>
      <div class="hbg"><div class="hfill" id="hf1" style="width:100%"></div></div>
    </div>
    <div class="hud-mid">
      <span id="rndTxt">ROUND 1</span>
      <span id="tmr">30</span>
      <span id="hudScr">0 - 0</span>
      <span id="hudTC">&#9670; 0 TC</span>
    </div>
    <div class="fhud" style="text-align:right;">
      <div class="fname" style="display:flex;justify-content:flex-end;" id="p2HudName">CPU IRON</div>
      <div class="hbg"><div class="hfill" id="hf2" style="width:100%"></div></div>
    </div>
  </div>
  <canvas id="gameCanvas" width="640" height="360"></canvas>
  <div id="hitFlash"></div>
  <div id="celebrationOverlay"></div>
  <div id="gameOverlay">
    <div class="go-title" id="goTitle"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
      <button class="gbtn sm" id="goMainBtn">CONTINUE</button>
      <button class="gbtn sm ghost" id="goMenuBtn">MAIN MENU</button>
    </div>
  </div>
  <div id="mobileUI">
    <div class="dpad">
      <div class="dp blank"></div>
      <div class="dp blank"></div>
      <div class="dp blank"></div>
      <div class="dp" id="dleft">&#9664;</div>
      <div class="dp blank"></div>
      <div class="dp" id="dright">&#9654;</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;align-items:center;">
      <div id="onlinePingBadge" style="display:none;" class="online-badge">
        <span class="ping-dot" style="display:inline-block;"></span> ONLINE
      </div>
      <button class="abtn menubtn" onclick="G.goToMenu()">MENU</button>
    </div>
    <div class="act-btns">
      <div class="act-row">
        <div class="abtn jbtn" id="bjab">JAB<br><span style="font-size:4px;color:#888;">M1</span></div>
        <div class="abtn hbtn" id="bheavy">HEAVY<br><span style="font-size:4px;color:#888;">M2</span></div>
      </div>
      <div class="act-row">
        <div class="abtn bbtn" id="bblock">BLOCK<br><span style="font-size:4px;color:#888;">SPC</span></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ── CONSTANTS ── */
var JAB_CD=12, HEAVY_CD=300, BLOCK_CD=15;

/* ── SUPABASE ── */
var SB_URL='https://llcwhpgxyaydevphxhbo.supabase.co';
var SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsY3docGd4eWF5ZGV2cGh4aGJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4OTcwMjIsImV4cCI6MjA4NzQ3MzAyMn0.Hcuty0_1BSgGf0H83I-vwG9weCD6Q_tf-9B2RUd6v3A';
var sb=null;
try{sb=window.supabase.createClient(SB_URL,SB_KEY);}catch(e){console.warn('No Supabase');}

/* ── CATALOGS ── */
var SHORTS_CATALOG=[
  {id:'default',name:'CLASSIC',price:0,col1:'#cc1111',col2:'#880000'},
  {id:'ocean',name:'OCEAN',price:50,col1:'#1155cc',col2:'#003388'},
  {id:'viper',name:'VIPER',price:75,col1:'#117711',col2:'#004400'},
  {id:'champ',name:'CHAMPION',price:150,col1:'#ccaa00',col2:'#886600'},
  {id:'royale',name:'ROYALE',price:200,col1:'#8822cc',col2:'#551188'},
  {id:'shadow',name:'SHADOW',price:300,col1:'#222222',col2:'#000000'},
  {id:'ghost',name:'GHOST',price:300,col1:'#dddddd',col2:'#aaaaaa'},
  {id:'inferno',name:'INFERNO',price:500,col1:'#ff4400',col2:'#cc2200'}
];

var GLOVE_CATALOG=[
  {id:'classic',name:'CLASSIC',price:0,col:'#dd2200',shd:'#881100'},
  {id:'blue',name:'COBALT',price:60,col:'#1155ee',shd:'#002299'},
  {id:'black',name:'BLACKOUT',price:80,col:'#222222',shd:'#000000'},
  {id:'gold',name:'GOLD',price:120,col:'#ddaa00',shd:'#886600'},
  {id:'green',name:'VENOM',price:100,col:'#117733',shd:'#004422'},
  {id:'white',name:'IVORY',price:90,col:'#dddddd',shd:'#999999'},
  {id:'purple',name:'ROYALE',price:150,col:'#8822cc',shd:'#441188'},
  {id:'pink',name:'FLAMINGO',price:200,col:'#dd4488',shd:'#882244'}
];

/* ── PLAYER PROFILE ── */
var player={
  id:null,name:'FIGHTER',tc:0,isGuest:true,tutorialDone:false,
  ownedShorts:['default'],equippedShorts:'default',
  ownedGloves:['classic'],equippedGloves:'classic',
  stats:{wins:0,losses:0,kos:0,rounds:0,totalTC:0},
  history:[]
};

function getEquippedColors(){
  var s=SHORTS_CATALOG.find(function(x){return x.id===player.equippedShorts;})||SHORTS_CATALOG[0];
  return [s.col1,s.col2];
}
function getEquippedGloveColors(){
  var g=GLOVE_CATALOG.find(function(x){return x.id===player.equippedGloves;})||GLOVE_CATALOG[0];
  return [g.col,g.shd];
}

/* ── LOCAL STORAGE SAVE (guest / offline fallback) ── */
function saveLocal(){
  try{localStorage.setItem('rb_profile',JSON.stringify(player));}catch(e){}
}
function loadLocal(){
  try{
    var d=localStorage.getItem('rb_profile');
    if(d){var p=JSON.parse(d);Object.assign(player,p);return true;}
  }catch(e){}
  return false;
}

async function saveProfile(){
  saveLocal();
  if(!sb||!player.id||player.isGuest) return;
  await sb.from('fighters').upsert({
    id:player.id,name:player.name,tc:player.tc,
    owned_shorts:player.ownedShorts,equipped_shorts:player.equippedShorts,
    owned_gloves:player.ownedGloves||['classic'],equipped_gloves:player.equippedGloves||'classic',
    wins:player.stats.wins,losses:player.stats.losses,kos:player.stats.kos,
    rounds:player.stats.rounds,total_tc:player.stats.totalTC,
    history:player.history.slice(0,30)
  });
}

async function loadProfile(uid){
  try{
    var res=await sb.from('fighters').select('*').eq('id',uid).single();
    if(res.data){
      player.id=uid;player.isGuest=false;
      player.name=res.data.name||'FIGHTER';
      player.tc=res.data.tc||0;
      player.ownedShorts=res.data.owned_shorts||['default'];
      player.equippedShorts=res.data.equipped_shorts||'default';
      player.ownedGloves=res.data.owned_gloves||['classic'];
      player.equippedGloves=res.data.equipped_gloves||'classic';
      player.stats={wins:res.data.wins||0,losses:res.data.losses||0,
        kos:res.data.kos||0,rounds:res.data.rounds||0,totalTC:res.data.total_tc||0};
      player.history=res.data.history||[];
      saveLocal();
      return true;
    }
  }catch(e){}
  return false;
}

/* ── AUTH ── */
async function doLogin(){
  if(!sb){doGuest();return;}
  var email=document.getElementById('loginEmail').value.trim();
  var pass=document.getElementById('loginPass').value;
  var err=document.getElementById('loginErr');
  if(!email||!pass){err.textContent='ENTER EMAIL AND PASSWORD!';return;}
  err.textContent='LOGGING IN...';
  try{
    var res=await sb.auth.signInWithPassword({email:email,password:pass});
    if(res.error){
      var msg=res.error.message.toUpperCase();
      if(msg.includes('INVALID')||msg.includes('CREDENTIALS'))msg='WRONG EMAIL OR PASSWORD!';
      if(msg.includes('NOT CONFIRMED'))msg='CHECK YOUR EMAIL TO CONFIRM!';
      err.textContent=msg;return;
    }
    var uid=res.data.user.id;
    var loaded=await loadProfile(uid);
    if(!loaded){
      var savedName=(localStorage.getItem('pendingFighterName')||'FIGHTER').toUpperCase().slice(0,10);
      localStorage.removeItem('pendingFighterName');
      var def={id:uid,name:savedName,tc:100,owned_shorts:['default'],equipped_shorts:'default',
        owned_gloves:['classic'],equipped_gloves:'classic',
        wins:0,losses:0,kos:0,rounds:0,total_tc:100,history:[]};
      await sb.from('fighters').upsert(def);
      await loadProfile(uid);
    }
    showScreen('menuScreen');updateMenuUI();
  }catch(e){err.textContent='ERROR: '+e.message;}
}

async function doSignup(){
  if(!sb){doGuest();return;}
  var name=document.getElementById('signupName').value.trim().toUpperCase();
  var email=document.getElementById('signupEmail').value.trim();
  var pass=document.getElementById('signupPass').value;
  var err=document.getElementById('signupErr');
  if(!name){err.textContent='ENTER A FIGHTER NAME!';return;}
  if(!email){err.textContent='ENTER YOUR EMAIL!';return;}
  if(pass.length<6){err.textContent='PASSWORD MIN 6 CHARS!';return;}
  err.textContent='CREATING ACCOUNT...';
  try{
    var res=await sb.auth.signUp({email:email,password:pass});
    if(res.error){err.textContent=res.error.message.toUpperCase();return;}
    localStorage.setItem('pendingFighterName',name);
    var needsConfirm=!res.data.user||(res.data.user.identities&&res.data.user.identities.length===0);
    if(needsConfirm){
      err.className='msg-line msg-ok';
      err.textContent='CHECK YOUR EMAIL AND CLICK THE LINK, THEN LOG IN!';
      return;
    }
    var uid=res.data.user.id;
    var def={id:uid,name:name,tc:100,owned_shorts:['default'],equipped_shorts:'default',
      owned_gloves:['classic'],equipped_gloves:'classic',
      wins:0,losses:0,kos:0,rounds:0,total_tc:100,history:[]};
    await sb.from('fighters').upsert(def);
    await loadProfile(uid);
    showScreen('menuScreen');updateMenuUI();
  }catch(e){err.textContent='ERROR: '+e.message;}
}

async function doLogout(){
  if(sb)await sb.auth.signOut();
  player={id:null,name:'FIGHTER',tc:0,isGuest:true,tutorialDone:false,
    ownedShorts:['default'],equippedShorts:'default',
    ownedGloves:['classic'],equippedGloves:'classic',
    stats:{wins:0,losses:0,kos:0,rounds:0,totalTC:0},history:[]};
  localStorage.removeItem('rb_profile');
  switchTab('login');
  showScreen('authScreen');
}

function doGuest(){
  /* Try to load local save for guests */
  var had=loadLocal();
  if(!had){player.isGuest=true;player.name='GUEST';player.tc=0;player.tutorialDone=player.tutorialDone||false;}
  player.isGuest=true;
  showScreen('menuScreen');updateMenuUI();
}

/* ── SCREENS ── */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  var el=document.getElementById(id);
  if(el)el.classList.add('active');
}

function switchTab(tab){
  var lf=document.getElementById('loginForm'),sf=document.getElementById('signupForm');
  var tl=document.getElementById('tabLogin'),ts=document.getElementById('tabSignup');
  if(tab==='login'){lf.style.display='flex';sf.style.display='none';tl.classList.add('active');ts.classList.remove('active');}
  else{lf.style.display='none';sf.style.display='flex';tl.classList.remove('active');ts.classList.add('active');}
}

function updateMenuUI(){
  document.getElementById('menuName').textContent=player.name;
  document.getElementById('menuTC').textContent='\u25C6 '+player.tc+' TC';
}

function saveName(){
  var val=document.getElementById('nameInput').value.trim().toUpperCase().slice(0,10);
  var msg=document.getElementById('nameMsg');
  if(!val){msg.className='msg-line msg-err';msg.textContent='ENTER A NAME!';return;}
  player.name=val;saveProfile();updateMenuUI();
  msg.className='msg-line msg-ok';msg.textContent='NAME SAVED!';
  setTimeout(function(){msg.textContent='';},2000);
}

/* ── SHOP ── */
function renderShop(){
  document.getElementById('shopTC').textContent='\u25C6 '+player.tc+' TC';
  document.getElementById('shopMsg').textContent='';
  // Shorts
  var grid=document.getElementById('shopGrid');
  grid.innerHTML='';
  SHORTS_CATALOG.forEach(function(s){
    var owned=player.ownedShorts.indexOf(s.id)>=0;
    var equipped=player.equippedShorts===s.id;
    var card=document.createElement('div');
    card.className='item-card'+(equipped?' equipped':owned?' owned':'');
    var sw=document.createElement('canvas');sw.width=44;sw.height=32;
    var sc=sw.getContext('2d');
    var gr=sc.createLinearGradient(0,0,44,32);
    gr.addColorStop(0,s.col1);gr.addColorStop(1,s.col2);
    sc.fillStyle=gr;sc.fillRect(0,0,44,32);
    sc.fillStyle='rgba(255,255,255,0.15)';sc.fillRect(6,0,7,32);
    var nm=document.createElement('div');nm.className='item-name';nm.textContent=s.name;
    var pr=document.createElement('div');pr.className='item-price';
    pr.textContent=s.price===0?'FREE':s.price+' TC';
    var btn=document.createElement('button');
    btn.style.cssText="font-family:'Press Start 2P',monospace;font-size:5px;padding:5px 3px;width:100%;cursor:pointer;border:none;margin-top:2px;";
    if(equipped){btn.textContent='EQUIPPED';btn.style.background='#00cc55';btn.style.color='#000';}
    else if(owned){
      btn.textContent='EQUIP';btn.style.background='var(--gold)';btn.style.color='#000';
      btn.onclick=function(){player.equippedShorts=s.id;saveProfile();renderShop();updateMenuUI();};
    }else{
      btn.textContent='BUY '+s.price+' TC';
      btn.style.background=player.tc>=s.price?'var(--gold)':'#333';
      btn.style.color=player.tc>=s.price?'#000':'#666';
      btn.onclick=function(){
        var m=document.getElementById('shopMsg');
        if(player.tc<s.price){m.className='msg-line msg-err';m.textContent='NOT ENOUGH TC!';return;}
        player.tc-=s.price;player.ownedShorts.push(s.id);player.equippedShorts=s.id;
        saveProfile();renderShop();updateMenuUI();
        m.className='msg-line msg-ok';m.textContent='PURCHASED!';
      };
    }
    card.appendChild(sw);card.appendChild(nm);card.appendChild(pr);card.appendChild(btn);
    grid.appendChild(card);
  });
  // Gloves
  renderGloveShop();
}

function renderGloveShop(){
  var grid=document.getElementById('shopGloveGrid');
  grid.innerHTML='';
  GLOVE_CATALOG.forEach(function(g){
    var owned=(player.ownedGloves||['classic']).indexOf(g.id)>=0;
    var equipped=(player.equippedGloves||'classic')===g.id;
    var card=document.createElement('div');
    card.className='glove-card'+(equipped?' equipped':owned?' owned':'');
    card.style.position='relative';
    // Draw glove swatch
    var sw=document.createElement('canvas');sw.width=36;sw.height=28;sw.style.imageRendering='pixelated';
    var sc=sw.getContext('2d');
    drawGloveToCanvas(sc,18,14,g.col,g.shd);
    var nm=document.createElement('div');nm.className='item-name';nm.textContent=g.name;
    var pr=document.createElement('div');pr.className='item-price';
    pr.textContent=g.price===0?'FREE':g.price+' TC';
    var btn=document.createElement('button');
    btn.style.cssText="font-family:'Press Start 2P',monospace;font-size:5px;padding:5px 3px;width:100%;cursor:pointer;border:none;margin-top:2px;";
    if(equipped){btn.textContent='ON';btn.style.background='#00cc55';btn.style.color='#000';}
    else if(owned){
      btn.textContent='EQUIP';btn.style.background='var(--gold)';btn.style.color='#000';
      btn.onclick=function(){player.equippedGloves=g.id;saveProfile();renderShop();updateMenuUI();};
    }else{
      btn.textContent=g.price+' TC';
      btn.style.background=player.tc>=g.price?'var(--gold)':'#333';
      btn.style.color=player.tc>=g.price?'#000':'#666';
      btn.onclick=function(){
        var m=document.getElementById('shopMsg');
        if(player.tc<g.price){m.className='msg-line msg-err';m.textContent='NOT ENOUGH TC!';return;}
        player.tc-=g.price;
        if(!player.ownedGloves)player.ownedGloves=['classic'];
        player.ownedGloves.push(g.id);player.equippedGloves=g.id;
        saveProfile();renderShop();updateMenuUI();
        m.className='msg-line msg-ok';m.textContent='GLOVES BOUGHT!';
      };
    }
    card.appendChild(sw);card.appendChild(nm);card.appendChild(pr);card.appendChild(btn);
    grid.appendChild(card);
  });
}

function drawGloveToCanvas(sc,cx,cy,col,shd){
  var w=18,h=14;
  sc.fillStyle='#000';sc.fillRect(cx-w/2-1,cy-h/2-1,w+2,h+2);
  sc.fillStyle=col;sc.fillRect(cx-w/2,cy-h/2,w,h);
  sc.fillStyle=shd;sc.fillRect(cx-w/2,cy-h/2,5,h);
  sc.fillStyle=shd;sc.fillRect(cx-w/2,cy+h/2-3,w,3);
  sc.fillStyle='rgba(255,255,255,0.4)';sc.fillRect(cx-w/2+5,cy-h/2+2,2,h-4);
}

/* ── INVENTORY ── */
function switchInvTab(tab){
  ['shorts','gloves','stats','history'].forEach(function(t){
    document.getElementById('inv'+t.charAt(0).toUpperCase()+t.slice(1)).style.display=t===tab?'block':'none';
    document.getElementById('invTab'+t.charAt(0).toUpperCase()+t.slice(1)).className='inv-tab'+(t===tab?' active':'');
  });
  if(tab==='stats')renderStats();
  if(tab==='history')buildHistory();
  if(tab==='gloves')renderInvGloves();
}

function renderInventory(){
  document.getElementById('invTC').textContent='\u25C6 '+player.tc+' TC';
  switchInvTab('shorts');
  var grid=document.getElementById('invGrid');
  grid.innerHTML='';
  var owned=SHORTS_CATALOG.filter(function(s){return player.ownedShorts.indexOf(s.id)>=0;});
  if(!owned.length){grid.innerHTML='<div class="inv-empty">NO SHORTS OWNED</div>';return;}
  owned.forEach(function(s){
    var equipped=player.equippedShorts===s.id;
    var card=document.createElement('div');
    card.className='item-card'+(equipped?' equipped':' owned');
    card.onclick=function(){
      player.equippedShorts=s.id;saveProfile();renderInventory();updateMenuUI();
      var im=document.getElementById('invMsg');
      im.className='msg-line msg-ok';im.textContent=s.name+' EQUIPPED!';
      setTimeout(function(){im.textContent='';},2000);
    };
    var sw=document.createElement('canvas');sw.width=44;sw.height=32;
    var sc=sw.getContext('2d');
    var gr=sc.createLinearGradient(0,0,44,32);
    gr.addColorStop(0,s.col1);gr.addColorStop(1,s.col2);
    sc.fillStyle=gr;sc.fillRect(0,0,44,32);
    sc.fillStyle='rgba(255,255,255,0.15)';sc.fillRect(6,0,7,32);
    var nm=document.createElement('div');nm.className='item-name';nm.textContent=s.name;
    card.appendChild(sw);card.appendChild(nm);grid.appendChild(card);
  });
}

function renderInvGloves(){
  var grid=document.getElementById('invGloveGrid');
  grid.innerHTML='';
  var og=player.ownedGloves||['classic'];
  var owned=GLOVE_CATALOG.filter(function(g){return og.indexOf(g.id)>=0;});
  if(!owned.length){grid.innerHTML='<div class="inv-empty">NO GLOVES OWNED</div>';return;}
  owned.forEach(function(g){
    var equipped=(player.equippedGloves||'classic')===g.id;
    var card=document.createElement('div');
    card.className='glove-card'+(equipped?' equipped':' owned');
    card.style.position='relative';
    card.onclick=function(){
      player.equippedGloves=g.id;saveProfile();renderInvGloves();updateMenuUI();
      var im=document.getElementById('invMsg');
      im.className='msg-line msg-ok';im.textContent=g.name+' EQUIPPED!';
      setTimeout(function(){im.textContent='';},2000);
    };
    var sw=document.createElement('canvas');sw.width=36;sw.height=28;sw.style.imageRendering='pixelated';
    var sc=sw.getContext('2d');
    drawGloveToCanvas(sc,18,14,g.col,g.shd);
    var nm=document.createElement('div');nm.className='item-name';nm.textContent=g.name;
    card.appendChild(sw);card.appendChild(nm);grid.appendChild(card);
  });
}

function renderStats(){
  var sg=document.getElementById('statsGrid');sg.innerHTML='';
  [{val:player.stats.wins,lbl:'WINS'},{val:player.stats.losses,lbl:'LOSSES'},
   {val:player.stats.kos,lbl:"KO'S"},{val:player.tc,lbl:'TC BALANCE'}
  ].forEach(function(s){
    var b=document.createElement('div');b.className='stat-box';
    b.innerHTML='<span class="stat-val">'+s.val+'</span><span class="stat-lbl">'+s.lbl+'</span>';
    sg.appendChild(b);
  });
}

function buildHistory(){
  var hl=document.getElementById('historyList');
  hl.innerHTML='';
  if(!player.history.length){hl.innerHTML='<div style="color:#555;font-size:7px;text-align:center;">NO FIGHTS YET</div>';return;}
  player.history.slice(0,30).forEach(function(h){
    var won=h.result==='win';
    var row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #1a0033;';
    var res=document.createElement('span');
    res.style.cssText='font-size:7px;color:'+(won?'#66cc44':'#ff4444')+';';
    res.textContent=(won?'WIN':'LOSS')+' vs '+h.opponent;
    var info=document.createElement('span');
    info.style.cssText='font-size:5px;color:#555;text-align:right;';
    info.textContent=(h.ko?'KO':'DEC')+' | R'+h.rounds+' | +'+h.tc+'TC';
    row.appendChild(res);row.appendChild(info);hl.appendChild(row);
  });
}

/* ════════════════════════════════════════════════
   ONLINE MULTIPLAYER
════════════════════════════════════════════════ */
var onlineMode=false,isHost=false,myRoomCode='';
var realtimeChannel=null,opponentName='OPPONENT';
var guestKeys={left:false,right:false,block:false,atk:null};
var rematchWanted=false,rematchTimeout=null;

function genCode(){
  var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789',code='';
  for(var i=0;i<6;i++)code+=c[Math.floor(Math.random()*c.length)];
  return code;
}

function showOnlineLobby(){
  document.getElementById('lobbyModeSelect').style.display='flex';
  document.getElementById('lobbyWaiting').style.display='none';
  document.getElementById('lobbyErr').textContent='';
  showScreen('onlineScreen');
}

async function createRoom(){
  if(!sb){document.getElementById('lobbyErr').textContent='SUPABASE REQUIRED';return;}
  myRoomCode=genCode();isHost=true;
  document.getElementById('roomCodeDisplay').textContent=myRoomCode;
  document.getElementById('lobbyP1Name').textContent=player.name+' (YOU)';
  document.getElementById('lobbyP2Name').textContent='WAITING...';
  document.getElementById('lobbyP2Dot').className='lobby-dot waiting';
  document.getElementById('lobbyStatus').textContent='WAITING FOR OPPONENT...';
  document.getElementById('lobbyModeSelect').style.display='none';
  document.getElementById('lobbyWaiting').style.display='flex';
  subscribeToRoom(myRoomCode);
}

async function joinRoom(){
  if(!sb){document.getElementById('lobbyErr').textContent='SUPABASE REQUIRED';return;}
  var code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if(code.length!==6){document.getElementById('lobbyErr').textContent='ENTER 6-CHARACTER CODE';return;}
  myRoomCode=code;isHost=false;
  document.getElementById('roomCodeDisplay').textContent=myRoomCode;
  document.getElementById('lobbyP1Name').textContent='HOST';
  document.getElementById('lobbyP2Name').textContent=player.name+' (YOU)';
  document.getElementById('lobbyP2Dot').className='lobby-dot ready';
  document.getElementById('lobbyModeSelect').style.display='none';
  document.getElementById('lobbyWaiting').style.display='flex';
  subscribeToRoom(myRoomCode);
}

function subscribeToRoom(code){
  if(realtimeChannel)sb.removeChannel(realtimeChannel);
  realtimeChannel=sb.channel('room:'+code,{config:{broadcast:{self:false}}});
  realtimeChannel.on('broadcast',{event:'join'},function(payload){
    if(!isHost)return;
    opponentName=(payload.payload.name||'OPPONENT').slice(0,10);
    document.getElementById('lobbyP2Name').textContent=opponentName;
    document.getElementById('lobbyP2Dot').className='lobby-dot ready';
    realtimeChannel.send({type:'broadcast',event:'start',payload:{hostName:player.name}});
    setTimeout(function(){startOnlineGame();},1200);
  });
  realtimeChannel.on('broadcast',{event:'start'},function(payload){
    if(isHost)return;
    opponentName=(payload.payload.hostName||'OPPONENT').slice(0,10);
    setTimeout(function(){startOnlineGame();},600);
  });
  realtimeChannel.on('broadcast',{event:'inp'},function(payload){
    if(!isHost)return;
    var d=payload.payload;
    guestKeys.left=!!d.l;guestKeys.right=!!d.r;guestKeys.block=!!d.b;
    if(d.atk)guestKeys.atk=d.atk;
  });
  realtimeChannel.on('broadcast',{event:'state'},function(payload){
    if(isHost)return;
    applyHostState(payload.payload);
  });
  realtimeChannel.on('broadcast',{event:'gameover'},function(payload){
    if(isHost)return;
    onlineGameOver(!payload.payload.p1Won,payload.payload.ko);
  });
  realtimeChannel.on('broadcast',{event:'rematch'},function(payload){
    if(rematchWanted){
      if(rematchTimeout)clearTimeout(rematchTimeout);
      rematchWanted=false;
      guestKeys={left:false,right:false,block:false,atk:null};
      if(isHost)startOnlineGame();
    }else{
      document.getElementById('goTitle').textContent=(payload.payload.name||'OPPONENT')+'\nWANTS REMATCH!';
      document.getElementById('gameOverlay').classList.add('show');
      setOverlayBtn('ACCEPT!',function(){sendRematchRequest();});
    }
  });
  realtimeChannel.on('broadcast',{event:'leave'},function(){
    if(!gameActive)return;
    gameActive=false;clearInterval(timerID);
    var earned=60;player.tc+=earned;player.stats.wins++;
    player.history.unshift({result:'win',opponent:opponentName,rounds:round,ko:false,tc:earned});
    saveProfile();
    document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
    showGameOverlay('OPPONENT\nRAGE QUIT!\nYOU WIN!\n+'+earned+' TC','MAIN MENU',null);
  });
  realtimeChannel.subscribe(function(status){
    if(status==='SUBSCRIBED'&&!isHost){
      realtimeChannel.send({type:'broadcast',event:'join',payload:{name:player.name}});
    }
  });
}

function leaveChannel(){
  if(realtimeChannel&&sb){
    try{realtimeChannel.send({type:'broadcast',event:'leave',payload:{}});sb.removeChannel(realtimeChannel);}catch(e){}
    realtimeChannel=null;
  }
}
function leaveOnline(){leaveChannel();showScreen('menuScreen');updateMenuUI();}

var broadcastTick=0;
function hostBroadcastState(){
  if(!realtimeChannel||!p1||!p2)return;
  broadcastTick++;
  if(broadcastTick%2!==0)return;
  realtimeChannel.send({type:'broadcast',event:'state',payload:{
    p1:{x:p1.x,hp:p1.hp,stamina:p1.stamina,state:p1.state,leadHand:p1.leadHand,
        blocking:p1.blocking,bobPhase:p1.bobPhase,legPhase:p1.legPhase,walkDir:p1.walkDir,hurtFlash:p1.hurtFlash,
        shortCol1:p1.shortCol1,shortCol2:p1.shortCol2,gloveCol:p1.gloveCol,gloveShadow:p1.gloveShadow,
        blockAnim:p1.blockAnim},
    p2:{x:p2.x,hp:p2.hp,stamina:p2.stamina,state:p2.state,leadHand:p2.leadHand,
        blocking:p2.blocking,bobPhase:p2.bobPhase,legPhase:p2.legPhase,walkDir:p2.walkDir,hurtFlash:p2.hurtFlash,
        shortCol1:p2.shortCol1,shortCol2:p2.shortCol2,gloveCol:p2.gloveCol,gloveShadow:p2.gloveShadow,
        blockAnim:p2.blockAnim},
    timer:timer,score:score,particles:particles.slice(0,20),effects:effects.slice(0,8)
  }});
}

function applyHostState(s){
  if(!s||!p1||!p2)return;
  function applyF(f,d){
    f.x=d.x;f.hp=d.hp;f.stamina=d.stamina;f.state=d.state;
    f.leadHand=d.leadHand;f.blocking=d.blocking;f.bobPhase=d.bobPhase;
    f.legPhase=d.legPhase;f.walkDir=d.walkDir;f.hurtFlash=d.hurtFlash||0;
    f.shortCol1=d.shortCol1;f.shortCol2=d.shortCol2;
    f.gloveCol=d.gloveCol;f.gloveShadow=d.gloveShadow;
    f.blockAnim=d.blockAnim||0;
  }
  applyF(p1,s.p1);applyF(p2,s.p2);
  if(s.timer!==undefined)timer=s.timer;
  if(s.score)score=s.score;
  if(s.particles)particles=s.particles;
  if(s.effects)effects=s.effects;
  updateBars();
  document.getElementById('tmr').textContent=(timer<10?'0':'')+timer;
  document.getElementById('tmr').style.color=timer<=8?'#ff2244':'#ffdd00';
  document.getElementById('hudScr').textContent=score[0]+' - '+score[1];
}

var guestBroadcastTick=0,lastGuestSent={l:false,r:false,b:false};
function guestSendInputs(){
  if(!realtimeChannel)return;
  guestBroadcastTick++;
  var l=!!(K['KeyA']||K['ArrowLeft']);
  var r=!!(K['KeyD']||K['ArrowRight']);
  var b=!!(p2&&p2.blocking);
  var changed=(l!==lastGuestSent.l||r!==lastGuestSent.r||b!==lastGuestSent.b);
  if(!changed&&guestBroadcastTick%4!==0)return;
  lastGuestSent={l:l,r:r,b:b};
  realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:l,r:r,b:b}});
}

function applyGuestInputs(){
  if(!p2||!p1)return;
  p2.blocking=guestKeys.block;
  if(!p2.stunned&&p2.state!=='ko'&&p2.state!=='hurt'){
    p2.walkDir=0;
    if(guestKeys.left&&p2.x>70){p2.x-=2.5;p2.walkDir=-1;}
    if(guestKeys.right&&p2.x<W-70){p2.x+=2.5;p2.walkDir=1;}
  }
  if(guestKeys.atk){var a=guestKeys.atk;guestKeys.atk=null;doAtk(p2,p1,a);}
}

function startOnlineGame(){
  onlineMode=true;
  guestKeys={left:false,right:false,block:false,atk:null};
  lastGuestSent={l:false,r:false,b:false};
  broadcastTick=0;guestBroadcastTick=0;
  document.getElementById('onlinePingBadge').style.display='flex';
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById('gameWrapper').classList.add('active');
  if(isHost){
    startGame();
    document.getElementById('p1HudName').textContent=player.name;
    document.getElementById('p2HudName').textContent=opponentName;
  }else{
    round=1;score=[0,0];sessionTC=0;timer=30;
    var myCols=getEquippedColors();
    var myGloves=getEquippedGloveColors();
    p1=makeFighter(160,false);
    p2=makeFighter(480,false,true);
    p2.shortCol1=myCols[0];p2.shortCol2=myCols[1];
    p2.gloveCol=myGloves[0];p2.gloveShadow=myGloves[1];
    particles=[];effects=[];bloodDrops=[];sweatDrops=[];
    gameActive=true;
    document.getElementById('p1HudName').textContent=opponentName;
    document.getElementById('p2HudName').textContent=player.name;
    document.getElementById('rndTxt').textContent='ROUND 1';
    document.getElementById('tmr').textContent='99';
    document.getElementById('hudScr').textContent='0 - 0';
    document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
    document.getElementById('gameOverlay').classList.remove('show');
    updateBars();
  }
}

function hostGameOver(p1Won,ko){
  gameActive=false;clearInterval(timerID);
  if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'gameover',payload:{p1Won:p1Won,ko:ko}});
  onlineGameOver(p1Won,ko);
}

function onlineGameOver(iWon,ko){
  gameActive=false;clearInterval(timerID);
  var earned=iWon?(50+round*15):Math.max(2,round*3);
  player.tc+=earned;
  if(iWon)player.stats.wins++;else player.stats.losses++;
  player.history.unshift({result:iWon?'win':'loss',opponent:opponentName,rounds:round,ko:ko,tc:earned});
  saveProfile();
  document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
  if(iWon)showCelebration();
  rematchWanted=false;
  showGameOverlay((iWon?'YOU WIN!':'YOU LOSE!')+'\n+'+earned+' TC','REMATCH?',function(){sendRematchRequest();});
}

function sendRematchRequest(){
  if(!realtimeChannel)return;
  rematchWanted=true;
  document.getElementById('goTitle').textContent='WAITING FOR\nOPPONENT...';
  var btn=document.getElementById('goMainBtn');btn.style.display='none';
  document.getElementById('gameOverlay').classList.add('show');
  realtimeChannel.send({type:'broadcast',event:'rematch',payload:{name:player.name}});
  if(rematchTimeout)clearTimeout(rematchTimeout);
  rematchTimeout=setTimeout(function(){
    if(rematchWanted){rematchWanted=false;document.getElementById('goTitle').textContent='REMATCH\nTIMED OUT';setOverlayBtn('MAIN MENU',goToMenu);}
  },15000);
}

/* ════════════════════════════════════════════════
   GAME ENGINE
════════════════════════════════════════════════ */
var canvas=document.getElementById('gameCanvas');
var ctx=canvas.getContext('2d');
var W=canvas.width,H=canvas.height,GROUND=H-55;

var p1=null,p2=null;
var gameActive=false;
var particles=[],effects=[],bloodDrops=[],sweatDrops=[];
var shakeX=0,shakeY=0,shakeAmt=0,shakeDur=0;
var round=1,maxRounds=3,score=[0,0],timer=99,timerID=null,sessionTC=0;

function makeFighter(x,isCPU,isOnlineP2){
  var cols,gloveCols;
  if(isOnlineP2){cols=['#1133cc','#001888'];gloveCols=['#dd2200','#881100'];}
  else if(isCPU){cols=['#1133cc','#001888'];gloveCols=['#dd2200','#881100'];}
  else{cols=getEquippedColors();gloveCols=getEquippedGloveColors();}
  return{
    x:x,isCPU:!!isCPU,isOnlineP2:!!isOnlineP2,
    hp:100,stamina:100,
    state:'idle',stateTimer:0,punchT:0,punchTMax:1,
    jabCD:0,heavyCD:0,blockCD:0,
    punchCD:0,stunned:0,hurtFlash:0,
    blocking:false,blockAnim:0,postBlockRestore:0,blockRaisedAt:0,wasBlocking:false,
    leadHand:0,comboCount:0,lastPunchT:0,
    walkDir:0,legPhase:0,bobPhase:0,
    shortCol1:cols[0],shortCol2:cols[1],
    gloveCol:gloveCols[0],gloveShadow:gloveCols[1],
    celebAnim:0
  };
}

/* ── INPUT ── */
var K={};
document.addEventListener('keydown',function(e){
  if(K[e.code])return;K[e.code]=true;
  if(e.code==='Space'||e.code==='KeyF')e.preventDefault();
  if(!gameActive)return;
  var isBlock=(e.code==='Space'||e.code==='KeyF');
  var isJab=(e.code==='Digit1');
  var isHeavy=(e.code==='Digit2');
  if(isBlock){
    if(onlineMode&&!isHost){if(p2&&p2.blockCD<=0)p2.blocking=true;}
    else{if(p1&&p1.blockCD<=0)p1.blocking=true;}
  }
  if(isJab){
    if(onlineMode&&!isHost){if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:lastGuestSent.l,r:lastGuestSent.r,b:!!(p2&&p2.blocking),atk:'jab'}});}
    else if(tutMode&&tutPhase===1)doBagAtk('jab');
    else doAtk(p1,p2,'jab');
  }
  if(isHeavy){
    if(onlineMode&&!isHost){if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:lastGuestSent.l,r:lastGuestSent.r,b:!!(p2&&p2.blocking),atk:'heavy'}});}
    else if(tutMode&&tutPhase===1)doBagAtk('heavy');
    else doAtk(p1,p2,'heavy');
  }
});
document.addEventListener('keyup',function(e){
  K[e.code]=false;
  var isBlock=(e.code==='Space'||e.code==='KeyF');
  if(isBlock){
    if(onlineMode&&!isHost){if(p2){p2.blocking=false;p2.blockCD=BLOCK_CD;}}
    else{if(p1){p1.blocking=false;p1.blockCD=BLOCK_CD;}}
  }
});

canvas.addEventListener('mousedown',function(e){
  e.preventDefault();
  if(!gameActive)return;
  if(onlineMode&&!isHost){
    var atk=e.button===0?'jab':'heavy';
    guestKeys.atk=atk;
    if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:lastGuestSent.l,r:lastGuestSent.r,b:!!(p2&&p2.blocking),atk:atk}});
  }else if(tutMode&&tutPhase===1){
    if(e.button===0)doBagAtk('jab');
    if(e.button===2)doBagAtk('heavy');
  }else{
    if(e.button===0)doAtk(p1,p2,'jab');
    if(e.button===2)doAtk(p1,p2,'heavy');
  }
});
canvas.addEventListener('contextmenu',function(e){e.preventDefault();});

function wireBtn(id,dn,up){
  var el=document.getElementById(id);if(!el)return;
  el.addEventListener('pointerdown',function(e){e.preventDefault();el.classList.add('on');if(dn)dn();});
  el.addEventListener('pointerup',function(e){e.preventDefault();el.classList.remove('on');if(up)up();});
  el.addEventListener('pointerleave',function(e){e.preventDefault();el.classList.remove('on');if(up)up();});
  el.addEventListener('pointercancel',function(e){e.preventDefault();el.classList.remove('on');if(up)up();});
}
wireBtn('bjab',function(){
  if(!gameActive)return;
  if(onlineMode&&!isHost){if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:lastGuestSent.l,r:lastGuestSent.r,b:!!(p2&&p2.blocking),atk:'jab'}});}
  else if(tutMode&&tutPhase===1)doBagAtk('jab');
  else doAtk(p1,p2,'jab');
});
wireBtn('bheavy',function(){
  if(!gameActive)return;
  if(onlineMode&&!isHost){if(realtimeChannel)realtimeChannel.send({type:'broadcast',event:'inp',payload:{l:lastGuestSent.l,r:lastGuestSent.r,b:!!(p2&&p2.blocking),atk:'heavy'}});}
  else if(tutMode&&tutPhase===1)doBagAtk('heavy');
  else doAtk(p1,p2,'heavy');
});
wireBtn('bblock',
  function(){
    if(onlineMode&&!isHost){if(p2&&p2.blockCD<=0)p2.blocking=true;}
    else{if(p1&&p1.blockCD<=0)p1.blocking=true;}
  },
  function(){
    if(onlineMode&&!isHost){if(p2){p2.blocking=false;p2.blockCD=BLOCK_CD;}}
    else{if(p1){p1.blocking=false;p1.blockCD=BLOCK_CD;}}
  }
);
wireBtn('dleft',function(){K['KeyA']=true;},function(){K['KeyA']=false;});
wireBtn('dright',function(){K['KeyD']=true;},function(){K['KeyD']=false;});

/* ── ATTACK ── */
function doAtk(atk,def,type){
  if(!atk||!def)return;
  if(atk.stunned>0||atk.state==='ko'||atk.state==='hurt')return;
  if(type==='jab'&&atk.jabCD>0)return;
  if(type==='heavy'&&atk.heavyCD>0){addFX('COOLING!',atk.x,-60,'#888');return;}
  if(atk.stamina<8){addFX('NO STAM!',atk.x,-60,'#666');return;}

  /* Punching while blocking: drop guard for punch duration, then auto-restore */
  if(atk.blocking){
    atk.blocking=false;
    atk.blockAnim=0;
    atk.postBlockRestore=type==='jab'?22:36;
  }

  atk.leadHand=1-atk.leadHand;
  var jabFrames=16, hvyFrames=52;
  atk.state=type;atk.stateTimer=type==='jab'?jabFrames:hvyFrames;
  atk.punchT=atk.stateTimer;atk.punchTMax=atk.stateTimer;
  atk.punchCD=atk.stateTimer;
  if(type==='jab')atk.jabCD=JAB_CD;
  if(type==='heavy')atk.heavyCD=HEAVY_CD;
  atk.stamina=Math.max(0,atk.stamina-(type==='jab'?18:38));
  var now=Date.now();
  if(now-atk.lastPunchT<900)atk.comboCount++;else atk.comboCount=1;
  atk.lastPunchT=now;
  var reach=112+(type==='heavy'?14:0);
  var dist=Math.abs(atk.x-def.x);
  if(dist<=reach){
    var dmg=type==='jab'?6:14;
    dmg=Math.floor(dmg*(1+Math.min(atk.comboCount-1,4)*0.14));
    if(def.blocking){
      var blockBroken=(type==='heavy'&&def.stamina<25);
      if(blockBroken){
        def.blocking=false;def.blockCD=180;def.stunned=180;def.state='hurt';def.stateTimer=180;
        addFX('BLOCK BROKEN!',def.x,-85,'#ff4400');burst(def.x,GROUND-80,'#ff4400',22);
        doFlash('rgba(255,60,0,0.7)');doShakeEffect(16);
        def.hp=Math.max(0,def.hp-Math.floor(dmg*0.5));
      }else{
        /* Perfect block: guard raised 50-400ms before impact (parry timing window) */
        var timeSinceRaise=def.blockRaisedAt>0?(Date.now()-def.blockRaisedAt):9999;
        var perfectBlock=(timeSinceRaise>=50&&timeSinceRaise<=400);
        /* Tutorial: track block/perfect block on p1 (def===p1 means trainer hit player) */
        if(tutMode&&def===p1){tutTrackAtk(type,true,perfectBlock);}
        if(perfectBlock&&!tutMode){
          atk.stunned=180;atk.state='hurt';atk.stateTimer=180;
          addFX('PERFECT BLOCK!',def.x,-85,'#00ddff');
          burst(def.x,GROUND-80,'#00ddff',14);
          doFlash('rgba(0,160,255,0.3)');doShakeEffect(8);
        }
        dmg=Math.floor(dmg*0.08);def.stamina=Math.max(0,def.stamina-22);
        burst(def.x,GROUND-80,'#88aaff',5);addFX((!tutMode&&perfectBlock)?'':'BLOCKED!',def.x,-50,'#88aaff');
      }
    }else{
      burst(def.x,GROUND-88,type==='heavy'?'#ff4400':'#ffcc00',type==='heavy'?18:9);
      burst(def.x,GROUND-88,'#fff',3);
      /* Blood splatter on hit */
      bloodBurst(def.x,GROUND-88,type==='heavy'?8:3);
      /* Sweat flies on impact */
      sweatBurst(def.x,GROUND-78,type==='heavy'?6:3);
      doFlash(type==='heavy'?'rgba(255,60,0,0.32)':'rgba(255,220,0,0.18)');
      doShakeEffect(type==='heavy'?9:4);
      var lbl=type==='heavy'?'HEAVY!!':'JAB!';
      if(atk.comboCount>=2)lbl=atk.comboCount+'x COMBO!';
      if(atk.comboCount>=5)lbl='ON FIRE!! '+atk.comboCount+'x';
      addFX(lbl,def.x,-75-Math.random()*18,type==='heavy'?'#ff4400':'#ffdd00');
      def.hp=Math.max(0,def.hp-dmg);
      def.hurtFlash=12;def.stunned=type==='heavy'?38:12;
      def.state='hurt';def.stateTimer=def.stunned;
      if(def.hp<=0)doKO(def,atk);
    }
    updateBars();
  }else{
    addFX('MISS!',atk.x+(atk.isCPU||atk.isOnlineP2?-50:50),-48,'#444');
  }
}

function doKO(loser,winner){
  loser.state='ko';loser.stateTimer=9999;loser.hp=0;
  gameActive=false;clearInterval(timerID);
  doShakeEffect(16);
  if(onlineMode&&isHost){
    var p1Won=(winner===p1);
    if(p1Won)score[0]++;else score[1]++;
    updateBars();
    document.getElementById('hudScr').textContent=score[0]+' - '+score[1];
    setTimeout(function(){hostGameOver(p1Won,true);},1700);
    return;
  }
  var localWon=(winner===p1);
  if(winner===p1)score[0]++;else score[1]++;
  updateBars();
  document.getElementById('hudScr').textContent=score[0]+' - '+score[1];
  var earned=localWon?(50+round*15):5;
  sessionTC+=earned;player.tc+=earned;
  document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
  player.stats.kos+=1;
  if(localWon){player.stats.wins++;player.history.unshift({result:'win',opponent:'CPU IRON',rounds:round,ko:true,tc:earned});}
  else{player.stats.losses++;player.history.unshift({result:'loss',opponent:'CPU IRON',rounds:round,ko:true,tc:earned});}
  saveProfile();
  /* Start winner celebration */
  winner.celebAnim=120;
  var wname=localWon?player.name:'CPU IRON';
  var tcMsg=localWon?('\n+'+earned+' TC EARNED!'):'';
  if(localWon)showCelebration();
  setTimeout(function(){
    if(round<maxRounds){
      showGameOverlay('K.O.!!!\n'+wname+' WINS!'+tcMsg,'NEXT ROUND',function(){round++;beginRound();});
    }else{
      var fw=score[0]>score[1]?player.name:(score[1]>score[0]?'CPU IRON':'DRAW!');
      showGameOverlay('FINAL!\n'+fw+' WINS!\n+'+sessionTC+' TC','FIGHT AGAIN',function(){startGame();});
    }
  },1700);
}

/* ── CELEBRATION ── */
function showCelebration(){
  var overlay=document.getElementById('celebrationOverlay');
  overlay.innerHTML='';
  overlay.classList.add('show');
  var colors=['#ffdd00','#ff2244','#00cc55','#0099ff','#ff6600','#aa44ff','#ffffff'];
  for(var i=0;i<40;i++){
    var piece=document.createElement('div');
    piece.className='confetti-piece';
    piece.style.left=Math.random()*100+'%';
    piece.style.top='0px';
    piece.style.background=colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDelay=(Math.random()*1)+'s';
    piece.style.animationDuration=(1+Math.random()*0.8)+'s';
    piece.style.width=(6+Math.random()*8)+'px';
    piece.style.height=(6+Math.random()*8)+'px';
    piece.style.borderRadius=Math.random()>0.5?'50%':'0';
    overlay.appendChild(piece);
  }
  setTimeout(function(){overlay.classList.remove('show');overlay.innerHTML='';},2500);
}

/* ── CPU AI ── CPU can now roam the whole ring ── */
var cpuIntent='approach',cpuIT=0;
function updateCPU(){
  if(!p2||!p1||!gameActive||p2.stunned>0||p2.state==='ko'||p2.state==='hurt'){if(p2)p2.blocking=false;return;}
  var dist=Math.abs(p1.x-p2.x);
  cpuIT--;
  if(cpuIT<=0){
    var r=Math.random();
    if(dist>180){cpuIntent='approach';cpuIT=42;}
    else if(dist<60){cpuIntent='retreat';cpuIT=20;}
    else if(r<0.25){cpuIntent='block';cpuIT=25+Math.floor(Math.random()*20);}
    else if(r<0.52){cpuIntent='jab';cpuIT=20;}
    else if(r<0.78){cpuIntent='heavy';cpuIT=35;}
    else{cpuIntent='approach';cpuIT=28;}
  }
  p2.blocking=false;p2.walkDir=0;
  if(cpuIntent==='approach'){
    /* CPU moves toward p1 — can go anywhere in the ring */
    if(p2.x>p1.x+60){p2.x-=1.8;p2.walkDir=-1;}
    else if(p2.x<p1.x-60){p2.x+=1.8;p2.walkDir=1;}
  }else if(cpuIntent==='retreat'){
    /* Retreat away from p1, bounce off walls */
    if(p2.x>p1.x){p2.x=Math.min(W-60,p2.x+2.2);p2.walkDir=1;}
    else{p2.x=Math.max(60,p2.x-2.2);p2.walkDir=-1;}
  }else if(cpuIntent==='block'){
    p2.blocking=(p2.blockCD<=0);
  }else if(cpuIT%13===0){
    doAtk(p2,p1,cpuIntent);
  }
  /* CPU stays in ring bounds — full ring */
  p2.x=Math.max(60,Math.min(W-60,p2.x));
}

/* ── PARTICLES & EFFECTS ── */
function bloodBurst(x,y,n){
  for(var i=0;i<n;i++){
    bloodDrops.push({
      x:x+(Math.random()-.5)*10,
      y:y,
      vx:(Math.random()-.5)*6,
      vy:-(Math.random()*5+2),
      size:2+Math.random()*4,
      life:40+Math.random()*30,
      maxLife:70,
      splat:false
    });
  }
}
function sweatBurst(x,y,n){
  for(var i=0;i<n;i++){
    sweatDrops.push({
      x:x+(Math.random()-.5)*14,
      y:y,
      vx:(Math.random()-.5)*4,
      vy:-(Math.random()*3+1),
      size:1+Math.random()*2.5,
      life:25+Math.random()*20
    });
  }
}
function burst(x,y,col,n){
  for(var i=0;i<n;i++)particles.push({x:x,y:y,vx:(Math.random()-.5)*8,vy:(Math.random()-1.1)*7,col:col,size:3+Math.random()*5,life:26+Math.random()*18});
}
function addFX(t,rx,ry,col){effects.push({text:t,relX:rx,relY:ry,col:col,life:22,maxLife:22});}
function doFlash(col){var el=document.getElementById('hitFlash');el.style.background=col;el.style.opacity='1';setTimeout(function(){el.style.opacity='0';},95);}
function doShakeEffect(amt){shakeAmt=amt;shakeDur=15;}

/* ── DRAW FIGHTER (human, no hat, block covers face) ── */
function fr(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(x,y,w,h);}

function drawFighter(f){
  var cx=f.x,cy=GROUND;
  var facesLeft=(f.isCPU||f.isOnlineP2);
  var dir=facesLeft?-1:1;
  var isKO=f.state==='ko';
  var isJab=f.state==='jab',isHeavy=f.state==='heavy';
  var isBlk=f.blocking||(f.blockAnim>1);

  /* Skin tones */
  var skin='#c87040',skinD='#9a5020',skinL='#e09060';

  /* Colors from fighter */
  var sc1=f.shortCol1,sc2=f.shortCol2;
  var gc=f.gloveCol,gs=f.gloveShadow;

  if(!isKO){f.bobPhase+=0.1;if(f.walkDir!==0)f.legPhase+=0.22;}
  var bob=isKO?0:Math.sin(f.bobPhase)*2.2;
  var leg=Math.sin(f.legPhase)*9;

  ctx.save();
  ctx.translate(cx,cy+bob);

  if(isKO){
    /* KO sprawl */
    ctx.save();ctx.rotate(dir*0.48);
    fr(-22,-12,44,20,sc1);
    fr(-18,-30,36,20,skin);
    /* head */
    fr(-10,-50,20,20,skin);
    fr(dir>0?-10:-2,-54,10,10,skinD);
    /* arm on ground */
    fr(dir>0?10:-22,-25,14,22,skin);
    fr(dir>0?18:-20,-10,16,14,gc);
    ctx.restore();
  }else{
    /* ── LEGS & BOOTS ── */
    var lx=dir>0?-13:1,rx=dir>0?1:-13;
    /* Boot shadow */
    fr(rx-leg/2+2,4,13,12,'#111');fr(lx+leg/2+2,4,13,12,'#111');
    /* Boot */
    fr(rx-leg/2,0,14,14,'#2a2a44');fr(rx-leg/2+1,1,12,12,'#1a1a33');
    fr(lx+leg/2,0,14,14,'#2a2a44');fr(lx+leg/2+1,1,12,12,'#1a1a33');
    /* White sole */
    fr(rx-leg/2,11,14,3,'#cccccc');fr(lx+leg/2,11,14,3,'#cccccc');

    /* ── SHORTS ── */
    fr(-18,-24,36,28,sc1);
    /* waistband */
    fr(-18,-27,36,6,sc2);
    /* center stripe */
    fr(-3,-24,6,28,sc2);
    /* belt */
    fr(-18,-19,36,3,'#ffffff');
    /* leg hems */
    fr(-18,-1,16,3,sc2);fr(2,-1,16,3,sc2);

    /* ── TORSO (bare skin) ── */
    fr(-14,-56,28,34,skin);
    /* muscle definition */
    fr(dir>0?-4:-8,-52,8,24,skinD);
    fr(-12,-52,4,20,skinD);
    fr(8,-52,4,20,skinD);
    /* abs lines */
    fr(-10,-50,20,2,skinD);fr(-10,-44,20,2,skinD);fr(-10,-38,20,2,skinD);
    /* pecs */
    fr(-11,-60,10,8,skin);fr(1,-60,10,8,skin);
    fr(-11,-60,3,8,skinD);fr(1,-60,3,8,skinD);

    /* ── ARMS ── */
    /* Smooth punch extension using punchT progress (sine arc: extend fast, retract slow) */
    var jabProgress=0,hvyProgress=0;
    if(isJab&&f.punchTMax>0){
      var tNorm=1-(f.punchT/f.punchTMax); /* 0->1 */
      jabProgress=Math.sin(tNorm*Math.PI); /* peaks at 0.5, returns to 0 */
    }
    if(isHeavy&&f.punchTMax>0){
      var tNorm2=1-(f.punchT/f.punchTMax);
      /* Heavy: slow windup (0-0.5) then FAST release (0.5-0.7) then slow retract */
      if(tNorm2<0.5) hvyProgress=tNorm2*0.3; /* barely moves during charge */
      else hvyProgress=0.15+Math.sin((tNorm2-0.5)*Math.PI)*0.85; /* explosive extension */
    }
    var jabOff=jabProgress*52*dir;   /* jab extends 52px */
    var hvyOff=hvyProgress*68*dir;   /* heavy extends 68px */

    if(isBlk){
      /* BLOCK: both arms raised, cross guard covers face */
      var ba=Math.min(f.blockAnim,8);
      var bLift=ba*1.5;
      /* Upper arms */
      fr(dir>0?-14:-2,-60+bLift*0.3,12,28,skinD);
      fr(dir>0?2:-14,-58+bLift*0.3,12,28,skin);
      /* Forearms crossed in front of face */
      fr(dir>0?-10:-6,-74+bLift*0.2,16,10,skin);
      fr(dir>0?-6:-10,-70+bLift*0.2,12,14,skin);
      /* Gloves covering face */
      var gox=dir>0?-14:-2, goy=-82+bLift*0.15;
      /* Left glove */
      fr(gox-2,goy-2,22,18,'#000');
      fr(gox,goy,20,16,gs);fr(gox,goy,20,16,gc);
      fr(gox,goy,6,16,gs);
      fr(gox,goy+2,3,12,'rgba(255,255,255,0.3)');
      /* Right glove overlapping */
      var go2x=dir>0?-2:-14,go2y=goy+10;
      fr(go2x-2,go2y-2,22,18,'#000');
      fr(go2x,go2y,20,16,gs);fr(go2x,go2y,20,16,gc);
      fr(go2x,go2y,6,16,gs);
    }else{
      /* ── ARMS & GLOVES ── both same size, both animate ──
         Front hand (near side): positioned at inside
         Back hand (far side):  positioned at outside
         On jab:   front hand extends forward
         On heavy: back hand extends forward
         Both bob gently in idle via bobPhase offset
      */
      var GW=20, GH=16; /* uniform glove size */
      var idleBobA=Math.sin(f.bobPhase)*2;
      var idleBobB=Math.sin(f.bobPhase+1.2)*2;

      /* Front glove: extends on JAB (leadHand===0) */
      var frontExt=(isJab&&f.leadHand===0)?jabOff:0;
      /* Back glove: extends on HEAVY (leadHand===1) */
      var backExt=(isHeavy&&f.leadHand===1)?hvyOff:0;

      var GW=20,GH=16;

      /* Front glove: extends on JAB (leadHand===0) */
      var frontExt=(isJab&&f.leadHand===0)?jabOff:0;
      /* Back glove: extends on HEAVY (leadHand===1) */
      var backExt=(isHeavy&&f.leadHand===1)?hvyOff:0;

      /* Glove resting X origins (shoulder) */
      var frontShoulderX=dir>0?-8:8-GW;
      var backShoulderX=dir>0?6:-6-GW;

      /* Final glove positions */
      var fgx=frontShoulderX+frontExt;
      var fgy=-48+idleBobA;
      var bgx=backShoulderX+backExt;
      var bgy=-60+idleBobB;

      /* ── Draw BACK arm first (behind body) ── */
      /* Arm segment stretches from shoulder to glove */
      var backArmStartX=dir>0?8:-8;
      var backGloveCenterX=bgx+(dir>0?GW/2:-GW/2);
      var backArmLen=Math.max(12,Math.abs(backGloveCenterX-backArmStartX));
      var backArmX=dir>0?backArmStartX:backGloveCenterX;
      fr(backArmX,-54+idleBobB,backArmLen,10,skinD);
      /* Upper back arm */
      fr(dir>0?2:-14,-64+idleBobB,12,14,skinD);

      /* ── Draw FRONT arm (in front of body) ── */
      var frontArmStartX=dir>0?-14:2;
      var frontGloveCenterX=fgx+(dir>0?GW/2:-GW/2);
      var frontArmLen=Math.max(12,Math.abs(frontGloveCenterX-frontArmStartX));
      var frontArmX=dir>0?frontArmStartX:frontGloveCenterX;
      fr(frontArmX,-52+idleBobA,frontArmLen,10,skin);
      /* Upper front arm */
      fr(dir>0?-14:2,-62+idleBobA,12,14,skin);

      /* Heavy charge glow on fist during windup */
      if(isHeavy&&hvyProgress<0.15&&f.punchTMax>0){
        var chargeGlow=1-(hvyProgress/0.15);
        ctx.save();
        ctx.globalAlpha=chargeGlow*0.7;
        ctx.shadowColor='#ff6600';ctx.shadowBlur=16+chargeGlow*10;
        ctx.fillStyle='rgba(255,120,0,0.6)';
        var gCx=bgx+GW/2,gCy=bgy+GH/2;
        ctx.beginPath();ctx.arc(gCx,gCy,(GW/2+4+chargeGlow*8),0,Math.PI*2);ctx.fill();
        ctx.restore();
      }

      /* Heavy punch motion trail */
      if(isHeavy&&hvyProgress>0.14&&hvyProgress<0.85){
        var trailAlpha=(hvyProgress-0.14)*0.5;
        ctx.save();ctx.globalAlpha=Math.min(0.4,trailAlpha);
        /* trail behind the fist */
        var trailOff=dir>0?-12:12;
        ctx.fillStyle='#ff4400';
        ctx.fillRect(bgx+trailOff,bgy+2,GW*0.6,GH-4);
        ctx.fillStyle='#ffaa00';
        ctx.fillRect(bgx+trailOff*1.6,bgy+4,GW*0.4,GH-8);
        ctx.restore();
      }

      /* Helper: draw one glove */
      function drawGlove(gx,gy,isActive,activeType){
        fr(gx-2,gy-2,GW+4,GH+4,'#000');
        fr(gx,gy,GW,GH,gs);fr(gx,gy,GW,GH,gc);
        fr(gx,gy,6,GH,gs);
        fr(gx,gy+2,3,GH-4,'rgba(255,255,255,0.28)');
        /* Highlight edge */
        fr(gx+GW-3,gy+2,2,GH-4,'rgba(255,255,255,0.15)');
        if(isActive&&activeType==='jab'){
          fr(gx+(dir>0?GW-2:-6),gy+1,8,7,'#ffff00');
          fr(gx+(dir>0?GW-2:-6),gy+7,8,5,'#ffaa00');
        }
        if(isActive&&activeType==='heavy'&&hvyProgress>0.14){
          /* Big impact star */
          var ix=gx+(dir>0?GW:-2),iy=gy+GH/2;
          ctx.save();ctx.globalAlpha=Math.min(1,(hvyProgress-0.14)*4);
          ctx.fillStyle='#ff6600';
          for(var si=0;si<6;si++){
            var sa=si*Math.PI/3,sl=8+Math.random()*4;
            ctx.fillRect(ix+Math.cos(sa)*4,iy+Math.sin(sa)*4,3,3);
          }
          ctx.fillStyle='#ffff00';ctx.fillRect(ix-3,iy-3,6,6);
          ctx.restore();
        }
      }

      drawGlove(fgx,fgy,isJab&&f.leadHand===0,'jab');
      drawGlove(bgx,bgy,isHeavy&&f.leadHand===1,'heavy');
    }

    /* ── HEAD (human, no hat) ── */
    if(isBlk&&f.blockAnim>3){
      /* Head is partially hidden behind gloves - just show top of head */
      var ha=Math.min(f.blockAnim/8,1);
      var headY=-88+(1-ha)*14;
      fr(-11,headY,22,Math.floor(28*ha),skin);
      /* hair */
      fr(-11,headY,22,5,'#2a1a08');
      fr(dir>0?-11:-3,headY+5,8,4,'#2a1a08');
    }else{
      /* Full head */
      fr(-11,-88,22,28,skin);
      fr(dir>0?-11:-3,-88,8,28,skinD);
      /* Eyes */
      fr(dir>0?3:-9,-78,6,5,'#1a1a1a');fr(dir>0?4:-8,-77,3,3,skinL);fr(dir>0?5:-9,-77,2,2,'#ffffff');
      /* Nose */
      fr(dir>0?2:-4,-72,4,6,skinD);
      /* Mouth */
      fr(dir>0?1:-5,-63,10,3,'#7a3010');
      /* Ear */
      fr(dir>0?-14:-2,-80,5,10,skin);fr(dir>0?-13:-3,-79,3,8,skinD);
      /* Hair - short */
      fr(-12,-92,24,8,'#2a1a08');
      fr(-11,-94,22,4,'#2a1a08');
      fr(-8,-95,16,3,'#2a1a08');
      fr(dir>0?-12:-2,-90,8,6,'#2a1a08');
      /* Eyebrow */
      fr(dir>0?2:-8,-83,8,2,'#2a1a08');
    }

    /* HURT FLASH */
    if(f.hurtFlash>0&&f.hurtFlash%3<2){
      ctx.fillStyle='rgba(255,80,0,0.45)';ctx.fillRect(-18,-96,36,98);
    }

    /* CELEBRATION animation */
    if(f.celebAnim>0){
      f.celebAnim--;
      var phase=f.celebAnim;
      /* Arms raised victory pose */
      if(phase>60){
        /* Both arms up */
        fr(dir>0?-20:-2,-88,12,34,skin);
        fr(dir>0?2:-14,-86,12,34,skin);
        /* Gloves raised */
        fr(dir>0?-22:-4,-118,18,14,'#000');fr(dir>0?-21:-3,-117,16,12,gc);
        fr(dir>0?4:-22,-116,18,14,'#000');fr(dir>0?5:-21,-115,16,12,gc);
      }else{
        /* Jumping/dancing - bob faster */
        var jmp=Math.abs(Math.sin(phase*0.2))*10;
        ctx.translate(0,-jmp);
      }
      /* Star bursts */
      if(phase%8===0){
        burst(cx+(Math.random()-.5)*60,GROUND-120,'#ffdd00',5);
        burst(cx+(Math.random()-.5)*60,GROUND-120,'#ff4400',3);
      }
    }
  }

  /* ── BIG BLUE SHIELD above fighter while blocking ── */
  if(isBlk&&!isKO&&f.blockAnim>1){
    var bAlpha=Math.min(1,f.blockAnim/8);
    var bPulse=1+Math.sin(Date.now()*0.012)*0.07;
    ctx.save();
    ctx.globalAlpha=bAlpha;
    ctx.scale(bPulse,bPulse);
    var sw=34,sh=40,sx2=-sw/2,sy2=-134;
    /* glow */
    ctx.shadowColor='#44aaff';ctx.shadowBlur=20;
    /* dark bg */
    ctx.fillStyle='#001a44';
    ctx.beginPath();
    ctx.moveTo(sx2,sy2);ctx.lineTo(sx2+sw,sy2);
    ctx.lineTo(sx2+sw,sy2+sh*0.6);
    ctx.quadraticCurveTo(sx2+sw,sy2+sh,sx2+sw/2,sy2+sh+8);
    ctx.quadraticCurveTo(sx2,sy2+sh,sx2,sy2+sh*0.6);
    ctx.closePath();ctx.fill();
    /* blue face */
    ctx.shadowBlur=0;
    ctx.fillStyle='rgba(20,90,255,0.93)';
    ctx.beginPath();
    ctx.moveTo(sx2+3,sy2+3);ctx.lineTo(sx2+sw-3,sy2+3);
    ctx.lineTo(sx2+sw-3,sy2+sh*0.6);
    ctx.quadraticCurveTo(sx2+sw-3,sy2+sh-2,sx2+sw/2,sy2+sh+4);
    ctx.quadraticCurveTo(sx2+3,sy2+sh-2,sx2+3,sy2+sh*0.6);
    ctx.closePath();ctx.fill();
    /* rim */
    ctx.strokeStyle='#88ddff';ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(sx2+3,sy2+3);ctx.lineTo(sx2+sw-3,sy2+3);
    ctx.lineTo(sx2+sw-3,sy2+sh*0.6);
    ctx.quadraticCurveTo(sx2+sw-3,sy2+sh-2,sx2+sw/2,sy2+sh+4);
    ctx.quadraticCurveTo(sx2+3,sy2+sh-2,sx2+3,sy2+sh*0.6);
    ctx.closePath();ctx.stroke();
    /* white cross */
    ctx.fillStyle='#ffffff';ctx.shadowColor='#aaddff';ctx.shadowBlur=8;
    ctx.fillRect(sx2+sw/2-3,sy2+9,6,22);
    ctx.fillRect(sx2+7,sy2+sh/2-4,sw-14,6);
    ctx.shadowBlur=0;
    ctx.restore();
  }

  ctx.restore();
}

function drawScene(){
  if(tutMode){ drawGymScene(); return; }
  /* ── BOXING RING ── */
  var sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,'#08001a');sky.addColorStop(0.7,'#180030');sky.addColorStop(1,'#2a0015');
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  for(var i=0;i<64;i++){
    var cx2=8+i*10+Math.sin(i*7.3)*2,cy2=H-155+Math.sin(i*2.1)*12;
    var cc=['#cc2200','#0033bb','#cc8800','#228800','#880088','#cccccc'][i%6];
    fr(cx2-4,cy2-18,8,18,cc);fr(cx2-4,cy2-30,8,12,'#c87040');
    var wv=Math.sin(i*0.8+Date.now()*0.003)*8;
    fr(cx2-8,cy2-24+wv,4,10,cc);fr(cx2+4,cy2-24-wv,4,10,cc);
  }
  fr(20,GROUND-120,10,130,'#ffdd00');fr(W-30,GROUND-120,10,130,'#ffdd00');
  for(var j=0;j<3;j++){
    var ry=GROUND-50-j*32;
    ctx.strokeStyle=j===1?'#cc2200':'#ffdd00';ctx.lineWidth=4;
    ctx.beginPath();ctx.moveTo(20,ry);ctx.lineTo(W-20,ry);ctx.stroke();
  }
  fr(20,GROUND,W-40,8,'#cc3300');fr(20,GROUND,W-40,3,'#ffdd00');
  fr(0,GROUND,W,6,'#cc2200');fr(20,GROUND+4,W-40,60,'#8B1a00');
  ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=2;ctx.setLineDash([8,8]);
  ctx.beginPath();ctx.moveTo(W/2,GROUND);ctx.lineTo(W/2,GROUND+60);ctx.stroke();
  ctx.setLineDash([]);
}

function drawGymScene(){
  /* ── GYM BACKGROUND ── fill full canvas first */
  fr(0,0,W,H,'#0d0808');
  /* ceiling */
  fr(0,0,W,H*0.55,'#1a1008');
  /* brick back wall */
  var brickW=40,brickH=18;
  for(var row=0;row<9;row++){
    for(var col=0;col<18;col++){
      var ox=(row%2===0)?0:brickW/2;
      var bx2=col*brickW-ox,by2=row*brickH;
      ctx.fillStyle=(row+col)%3===0?'#2a1208':'#221008';
      ctx.fillRect(bx2+1,by2+1,brickW-2,brickH-2);
      ctx.fillStyle='#1a0a04';
      ctx.fillRect(bx2,by2,brickW,1);
      ctx.fillRect(bx2,by2,1,brickH);
    }
  }
  /* GYM banner */
  fr(180,14,280,32,'#1a0000');
  fr(182,16,276,28,'#2a0000');
  ctx.font='bold 11px "Press Start 2P"';ctx.fillStyle='#ffdd00';ctx.textAlign='center';
  ctx.fillText('IRON GYM',W/2,36);ctx.textAlign='left';
  fr(182,44,276,2,'#ffdd00');

  /* ── EQUIPMENT IN BACKGROUND ── */
  /* Speed bag on right wall - only in bag phase */
  if(tutPhase===1){
    fr(520,80,8,30,'#888'); /* chain */
    fr(504,110,40,50,'#8B3300'); /* speed bag body */
    fr(506,112,36,46,'#a04400');
    fr(514,112,12,46,'#cc5500'); /* shine */
    fr(502,108,44,8,'#555'); /* mount */
  }
  /* Weight rack left side */
  fr(20,120,70,6,'#333');
  fr(22,126,8,60,'#555');fr(22,122,8,8,'#444');
  fr(60,126,8,60,'#555');fr(60,122,8,8,'#444');
  /* weights */
  for(var wi=0;wi<3;wi++){
    fr(30+wi*14,130,10,40,'#444');
    fr(31+wi*14,132,8,36,'#555');
  }
  /* Poster on left wall */
  fr(8,60,60,80,'#0a0000');fr(10,62,56,76,'#1a0000');
  ctx.font='bold 5px "Press Start 2P"';ctx.fillStyle='#ff2244';ctx.textAlign='center';
  ctx.fillText('FIGHT',38,90);ctx.fillText('HARD',38,102);ctx.textAlign='left';
  /* Poster on right wall */
  fr(W-68,60,60,80,'#0a0000');fr(W-66,62,56,76,'#001a00');
  ctx.font='bold 5px "Press Start 2P"';ctx.fillStyle='#00cc55';ctx.textAlign='center';
  ctx.fillText('TRAIN',W-38,90);ctx.fillText('WIN',W-38,102);ctx.textAlign='left';

  /* ── OVERHEAD GYM LIGHTS ── */
  var lightPositions=[120,320,520];
  lightPositions.forEach(function(lx){
    /* light fixture */
    fr(lx-15,0,30,12,'#333');
    fr(lx-18,10,36,6,'#555');
    /* light cone */
    ctx.save();ctx.globalAlpha=0.07+Math.sin(Date.now()*0.002)*0.01;
    ctx.fillStyle='#ffffcc';
    ctx.beginPath();
    ctx.moveTo(lx-18,16);ctx.lineTo(lx+18,16);
    ctx.lineTo(lx+80,GROUND);ctx.lineTo(lx-80,GROUND);
    ctx.closePath();ctx.fill();
    ctx.restore();
    /* bulb glow */
    ctx.save();ctx.globalAlpha=0.9;
    ctx.fillStyle='#ffffaa';ctx.fillRect(lx-8,11,16,5);
    ctx.restore();
  });

  /* ── WOOD FLOOR ── */
  /* floorboards */
  for(var fi=0;fi<W;fi+=32){
    ctx.fillStyle=fi%64===0?'#5a3a10':'#4a2e08';
    ctx.fillRect(fi,GROUND,32,H-GROUND);
    ctx.fillStyle='#3a2006';
    ctx.fillRect(fi,GROUND,1,H-GROUND);
  }
  /* floor sheen */
  ctx.save();ctx.globalAlpha=0.07;
  ctx.fillStyle='#ffffff';
  lightPositions.forEach(function(lx){
    ctx.beginPath();ctx.ellipse(lx,GROUND+2,70,8,0,0,Math.PI*2);ctx.fill();
  });
  ctx.restore();
  /* floor edge */
  fr(0,GROUND,W,3,'#3a2006');

  /* ── MIRROR on back wall (center) ── */
  fr(W/2-50,50,100,H*0.45,'#0a1a2a');
  fr(W/2-48,52,96,H*0.43,'#0d2030');
  /* mirror frame */
  ctx.strokeStyle='#888';ctx.lineWidth=3;
  ctx.strokeRect(W/2-50,50,100,H*0.45);
  /* mirror reflection - faint horizontal lines */
  ctx.save();ctx.globalAlpha=0.06;
  ctx.fillStyle='#aaddff';
  for(var mi=0;mi<8;mi++) ctx.fillRect(W/2-48,52+mi*22,96,10);
  ctx.restore();
  ctx.font='bold 5px "Press Start 2P"';ctx.fillStyle='rgba(100,160,200,0.4)';
  ctx.textAlign='center';ctx.fillText('MIRROR',W/2,H*0.5-5);ctx.textAlign='left';

  /* ── PROMPT: walk up to bag ── */
  if(tutPhase===1&&p1){
    var dist=Math.abs(p1.x-bag.x);
    if(dist>120){
      ctx.save();ctx.globalAlpha=0.85+Math.sin(Date.now()*0.006)*0.15;
      ctx.font='bold 7px "Press Start 2P"';ctx.fillStyle='#00ffcc';ctx.textAlign='center';
      ctx.fillText('WALK UP TO THE BAG  A/D',W/2,GROUND-10);
      ctx.restore();
    }
    ctx.textAlign='left';
  }
}

function drawEffects(){
  /* Blood drops */
  bloodDrops.forEach(function(bd){
    var alpha=bd.life/bd.maxLife;
    ctx.save();ctx.globalAlpha=Math.min(1,alpha*1.4);
    if(bd.splat){
      /* splat puddle on floor */
      ctx.fillStyle='#aa0000';
      ctx.beginPath();ctx.ellipse(bd.x,bd.y,bd.size*1.8,bd.size*0.6,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#cc1111';
      ctx.beginPath();ctx.ellipse(bd.x,bd.y,bd.size*0.8,bd.size*0.3,0,0,Math.PI*2);ctx.fill();
    }else{
      /* flying teardrop */
      ctx.fillStyle='#cc0000';
      ctx.fillRect(Math.round(bd.x),Math.round(bd.y),Math.ceil(bd.size),Math.ceil(bd.size));
      ctx.fillStyle='#ff2222';
      ctx.fillRect(Math.round(bd.x),Math.round(bd.y),Math.ceil(bd.size*0.5),Math.ceil(bd.size*0.5));
    }
    ctx.restore();
  });
  /* Sweat drops */
  sweatDrops.forEach(function(sw2){
    var alpha=sw2.life/25;
    ctx.save();ctx.globalAlpha=Math.min(0.85,alpha);
    ctx.fillStyle='#aaddff';
    ctx.beginPath();ctx.ellipse(sw2.x,sw2.y,sw2.size*0.6,sw2.size,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#ffffff';
    ctx.fillRect(Math.round(sw2.x-sw2.size*0.2),Math.round(sw2.y-sw2.size*0.3),1,1);
    ctx.restore();
  });
  /* Regular particles */
  particles.forEach(function(pt){
    ctx.fillStyle=pt.col;ctx.fillRect(Math.round(pt.x),Math.round(pt.y),Math.ceil(pt.size),Math.ceil(pt.size));
  });
  effects.forEach(function(e){
    var alpha=e.life/e.maxLife;
    ctx.save();ctx.globalAlpha=alpha;
    ctx.font='bold 11px "Press Start 2P"';ctx.fillStyle=e.col;
    ctx.textAlign='center';ctx.fillText(e.text,e.relX,GROUND+e.relY);
    ctx.restore();
  });
}

function drawStamBars(){
  if(!p1||!p2)return;
  function drawBar(f,x){
    fr(x-1,H-27,92,8,'#000');fr(x,H-26,90,6,'#333');
    fr(x,H-26,Math.floor(90*f.stamina/100),6,'#00cc55');
  }
  drawBar(p1,55);drawBar(p2,W-145);
  function drawHeavyBar(f,x){
    if(!f.heavyCD||f.heavyCD<=0)return;
    fr(x-1,H-17,92,7,'#220000');
    fr(x,H-16,Math.floor(90*f.heavyCD/HEAVY_CD),6,'#ff4400');
  }
  drawHeavyBar(p1,55);drawHeavyBar(p2,W-145);
}

function drawKOText(){
  if(!p1||!p2)return;
  if(p1.state!=='ko'&&p2.state!=='ko')return;
  ctx.textAlign='center';ctx.font='38px "Press Start 2P"';
  var gr=ctx.createLinearGradient(0,H/2-60,0,H/2);
  gr.addColorStop(0,'#ffff00');gr.addColorStop(1,'#ff4400');
  ctx.fillStyle='#000';ctx.fillText('K.O.!!!',W/2+4,H/2-22+2);
  ctx.fillStyle=gr;ctx.fillText('K.O.!!!',W/2,H/2-22);
  ctx.textAlign='left';
}

/* ── UPDATE ── */
function update(){
  if(!p1)return;
  if(!p2&&!tutMode)return; /* allow update with no p2 in tutorial bag phase */
  if(onlineMode&&!isHost){
    guestSendInputs();
    var np=[],ne=[],nb=[],nsw=[];
    for(var i=0;i<particles.length;i++){var pt=particles[i];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.28;pt.life--;if(pt.life>0)np.push(pt);}
    for(var j=0;j<effects.length;j++){var ef=effects[j];ef.relY-=0.55;ef.life--;if(ef.life>0)ne.push(ef);}
    for(var k=0;k<bloodDrops.length;k++){var bd=bloodDrops[k];if(!bd.splat){bd.x+=bd.vx;bd.y+=bd.vy;bd.vy+=0.45;bd.vx*=0.9;if(bd.y>=GROUND){bd.splat=true;bd.y=GROUND;bd.life=Math.min(bd.life,50);}}bd.life--;if(bd.life>0)nb.push(bd);}
    for(var m=0;m<sweatDrops.length;m++){var sw2=sweatDrops[m];sw2.x+=sw2.vx;sw2.y+=sw2.vy;sw2.vy+=0.3;sw2.life--;if(sw2.life>0)nsw.push(sw2);}
    particles=np;effects=ne;bloodDrops=nb;sweatDrops=nsw;return;
  }
  /* p1 movement */
  if(!p1.stunned&&p1.state!=='ko'&&p1.state!=='hurt'){
    p1.walkDir=0;
    /* In tutorial: lock movement while reading instruction (not waiting for action) */
    var moveLocked=tutMode&&!tutWaiting;
    if(!moveLocked){
      var rightLimit=tutMode?(tutPhase===1?bag.x+20:p2?p2.x-60:W-80):p2?p2.x-60:W-80;
      if((K['KeyA']||K['ArrowLeft'])&&p1.x>60){p1.x-=2.5;p1.walkDir=-1;}
      if((K['KeyD']||K['ArrowRight'])&&p1.x<rightLimit){p1.x+=2.5;p1.walkDir=1;}
    }
  }
  /* p2 movement */
  if(onlineMode){applyGuestInputs();}else if(tutMode){updateTrainer();}else{updateCPU();}
  /* Tick all fighter state */
  [p1,p2].filter(Boolean).forEach(function(f){
    if(f.punchCD>0)f.punchCD--;
    if(f.punchT>0)f.punchT--;
    if(f.jabCD>0)f.jabCD--;
    if(f.heavyCD>0)f.heavyCD--;
    if(f.blockCD>0){f.blockCD--;if(f.blockCD>0)f.blocking=false;}
    if(f.stunned>0)f.stunned--;
    if(f.hurtFlash>0)f.hurtFlash--;
    if(f.stateTimer>0){f.stateTimer--;if(f.stateTimer<=0&&f.state!=='ko')f.state='idle';}
    /* Auto-restore guard after punch-while-blocking */
    if(f.postBlockRestore>0){
      f.postBlockRestore--;
      if(f.postBlockRestore<=0&&!f.stunned&&f.state!=='ko'&&f.state!=='hurt'){
        f.blocking=true;
      }
    }
    if(!f.blocking)f.stamina=Math.min(100,f.stamina+0.12);
    if(f.blocking)f.stamina=Math.max(0,f.stamina-0.18); /* holding block drains stamina */
    /* Block anim lerp */
    if(f.blocking){
      if(f.blockAnim<8)f.blockAnim=Math.min(8,f.blockAnim+2);
      /* Only count as 'held' once fully raised */
      /* track when guard first became fully raised */
      if(f.blockAnim>=8&&!f.wasBlocking){f.blockRaisedAt=Date.now();f.wasBlocking=true;}
    }else{
      if(f.blockAnim>0)f.blockAnim=Math.max(0,f.blockAnim-2);
      f.wasBlocking=false;f.blockRaisedAt=0;
    }
  });
  if(!tutMode&&shakeDur>0){shakeX=(Math.random()-.5)*shakeAmt;shakeY=(Math.random()-.5)*shakeAmt;shakeAmt*=0.8;shakeDur--;}
  else{shakeX=0;shakeY=0;if(tutMode)shakeDur=0;}
  var np=[],ne=[],nb=[],nsw=[];
  for(var i=0;i<particles.length;i++){var pt=particles[i];pt.x+=pt.vx;pt.y+=pt.vy;pt.vy+=0.28;pt.life--;if(pt.life>0)np.push(pt);}
  for(var j=0;j<effects.length;j++){var ef=effects[j];ef.relY-=0.55;ef.life--;if(ef.life>0)ne.push(ef);}
  for(var k=0;k<bloodDrops.length;k++){
    var bd=bloodDrops[k];
    if(!bd.splat){bd.x+=bd.vx;bd.y+=bd.vy;bd.vy+=0.45;bd.vx*=0.9;
      if(bd.y>=GROUND){bd.splat=true;bd.y=GROUND;bd.life=Math.min(bd.life,50);} /* splat on floor */
    }
    bd.life--;if(bd.life>0)nb.push(bd);
  }
  for(var m=0;m<sweatDrops.length;m++){var sw2=sweatDrops[m];sw2.x+=sw2.vx;sw2.y+=sw2.vy;sw2.vy+=0.3;sw2.life--;if(sw2.life>0)nsw.push(sw2);}
  particles=np;effects=ne;bloodDrops=nb;sweatDrops=nsw;
  /* Passive sweat drip from fighters while active */
  if(gameActive&&p1&&p2){
    if(Math.random()<0.04)sweatBurst(p1.x+(Math.random()-.5)*10,GROUND-70+Math.random()*30,1);
    if(p2&&Math.random()<0.04)sweatBurst(p2.x+(Math.random()-.5)*10,GROUND-70+Math.random()*30,1);
    /* Heavy punch charge particles - orbit the fist during windup */
    function spawnCharge(f){
      if(f.state!=='heavy')return;
      var prog=1-(f.punchT/f.punchTMax); /* 0=start, 1=end */
      if(prog<0.55){ /* windup phase - sparks circle the fist */
        var facesLeft=(f.isCPU||f.isOnlineP2),dir2=facesLeft?-1:1;
        var fistX=f.x+(dir2>0?6:-6),fistY=GROUND-60;
        var angle=Date.now()*0.025+prog*12;
        var radius=6+prog*14;
        particles.push({
          x:fistX+Math.cos(angle)*radius,y:fistY+Math.sin(angle)*radius,
          vx:Math.cos(angle+1.57)*1.5,vy:Math.sin(angle+1.57)*1.5-0.5,
          col:prog>0.35?'#ff6600':'#ffdd00',size:2+prog*4,life:12+prog*8
        });
        if(prog>0.4&&Math.random()<0.3){
          particles.push({
            x:fistX+(Math.random()-.5)*20,y:fistY+(Math.random()-.5)*20,
            vx:(Math.random()-.5)*3,vy:-Math.random()*2,
            col:'#ff2200',size:3+Math.random()*4,life:10
          });
        }
      }
    }
    spawnCharge(p1);if(p2)spawnCharge(p2);
  }
  if(onlineMode)hostBroadcastState();
}

/* ── MAIN LOOP ── */
function loop(){
  update();
  ctx.clearRect(0,0,W,H); /* clear full canvas every frame - prevents trails */
  ctx.save();
  ctx.translate(Math.round(shakeX),Math.round(shakeY));
  drawScene();
  if(tutMode&&tutPhase===1)drawBag();
  if(tutMode&&tutPhase===2&&p2)drawFighter(p2);
  if(!tutMode&&p2)drawFighter(p2);
  if(p1)drawFighter(p1);
  drawEffects();
  drawStamBars();
  drawKOText();
  ctx.restore();
  requestAnimationFrame(loop);
}
loop();

function updateBars(){
  if(p1)document.getElementById('hf1').style.width=Math.max(0,p1.hp)+'%';
  if(p2)document.getElementById('hf2').style.width=Math.max(0,p2.hp)+'%';
}

/* ── OVERLAY ── */
function setOverlayBtn(label,fn){
  var btn=document.getElementById('goMainBtn');
  var newBtn=btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn,btn);
  newBtn.textContent=label||'CONTINUE';
  newBtn.style.display='';
  newBtn.addEventListener('click',function(){
    document.getElementById('gameOverlay').classList.remove('show');
    if(fn)fn();
  });
}
function showGameOverlay(title,btnLabel,nextFn){
  document.getElementById('goTitle').textContent=title;
  document.getElementById('gameOverlay').classList.add('show');
  setOverlayBtn(btnLabel||'CONTINUE',nextFn||goToMenu);
}
document.getElementById('goMenuBtn').addEventListener('click',function(){
  document.getElementById('gameOverlay').classList.remove('show');
  goToMenu();
});

/* ── GAME FLOW ── */
function startGame(){
  round=1;score=[0,0];sessionTC=0;
  document.getElementById('hudScr').textContent='0 - 0';
  document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
  beginRound();
}

function beginRound(){
  p1=makeFighter(160,false,false);
  p2=makeFighter(480,!onlineMode,onlineMode);
  if(onlineMode&&isHost){p2.shortCol1='#1133cc';p2.shortCol2='#001888';}
  cpuIntent='approach';cpuIT=0;
  particles=[];effects=[];bloodDrops=[];sweatDrops=[];
  document.getElementById('rndTxt').textContent='ROUND '+round;
  document.getElementById('tmr').textContent='30';
  document.getElementById('tmr').style.color='#ffdd00';
  document.getElementById('p1HudName').textContent=player.name;
  document.getElementById('p2HudName').textContent=onlineMode?opponentName:'CPU IRON';
  document.getElementById('gameOverlay').classList.remove('show');
  updateBars();
  gameActive=true;timer=30;
  clearInterval(timerID);
  if(!onlineMode||isHost){
    timerID=setInterval(function(){
      if(!gameActive)return;
      timer--;
      document.getElementById('tmr').textContent=(timer<10?'0':'')+timer;
      document.getElementById('tmr').style.color=timer<=8?'#ff2244':'#ffdd00';
      if(timer<=0){clearInterval(timerID);endByTime();}
    },1000);
  }
}

function endByTime(){
  gameActive=false;
  var p1Won=p1.hp>=p2.hp;
  if(p1Won)score[0]++;else score[1]++;
  document.getElementById('hudScr').textContent=score[0]+' - '+score[1];
  updateBars();
  if(onlineMode&&isHost){setTimeout(function(){hostGameOver(p1Won,false);},700);return;}
  var earned=p1Won?(25+round*8):2;
  sessionTC+=earned;player.tc+=earned;
  document.getElementById('hudTC').textContent='\u25C6 '+player.tc+' TC';
  if(p1Won){player.stats.wins++;player.history.unshift({result:'win',opponent:'CPU IRON',rounds:round,ko:false,tc:earned});}
  else{player.stats.losses++;player.history.unshift({result:'loss',opponent:'CPU IRON',rounds:round,ko:false,tc:earned});}
  saveProfile();
  if(p1Won)showCelebration();
  var n2=p1Won?player.name:'CPU IRON';
  setTimeout(function(){
    if(round<maxRounds){showGameOverlay('TIME UP!\n'+n2+' WINS!','NEXT ROUND',function(){round++;beginRound();});}
    else{var fw=score[0]>score[1]?player.name:(score[1]>score[0]?'CPU IRON':'DRAW!');showGameOverlay('FINAL!\n'+fw+' WINS!\n+'+sessionTC+' TC','FIGHT AGAIN',function(){startGame();});}
  },700);
}

function goToGame(){
  onlineMode=false;
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById('gameWrapper').classList.add('active');
  document.getElementById('onlinePingBadge').style.display='none';
  startGame();
}

function goToMenu(){
  if(onlineMode){leaveChannel();onlineMode=false;}
  gameActive=false;clearInterval(timerID);
  document.getElementById('gameWrapper').classList.remove('active');
  document.getElementById('onlinePingBadge').style.display='none';
  showScreen('menuScreen');updateMenuUI();
}

/* ── STARTUP ── */
(async function(){
  if(sb){
    try{
      var sess=await sb.auth.getSession();
      if(sess.data&&sess.data.session){
        await loadProfile(sess.data.session.user.id);
        showScreen('menuScreen');updateMenuUI();return;
      }
    }catch(e){}
  }
  showScreen('authScreen');
})();


/* ════════════════════════════════════════════════
   TUTORIAL SYSTEM
   Phase 1: Punching bag - learn jab & heavy
   Phase 2: Sparring - learn block
════════════════════════════════════════════════ */
var tutMode=false;
var tutPhase=0; /* 0=off, 1=bag, 2=spar */
var tutStep=0;
var tutWaiting=false; /* waiting for player action */
var tutJabsDone=0,tutHeaviesDone=0,tutBlocksDone=0,tutPerfectsDone=0;

/* Punching bag: a stationary target drawn on canvas */
var bag={x:480,hp:100,hurtFlash:0,swingAnim:0,swingDir:1};

var TUT_STEPS=[
  /* 0 */ {phase:1,msg:"WELCOME TO THE GYM!\nLET'S LEARN THE BASICS.",hint:'PRESS NEXT TO CONTINUE',wait:false},
  /* 1 */ {phase:1,msg:"WALK UP TO THE BAG\nAND THROW 3 JABS!",hint:'PRESS NEXT WHEN READY',wait:false},
  /* 2 */ {phase:1,msg:"",hint:'JAB - M1 OR [1]',wait:true,need:'jab',count:3},
  /* 3 */ {phase:1,msg:"NOW STEP BACK AND\nTRY 2 HEAVY PUNCHES!",hint:'PRESS NEXT WHEN READY',wait:false},
  /* 4 */ {phase:1,msg:"",hint:'HEAVY - M2 OR [2]',wait:true,need:'heavy',count:2},
  /* 5 */ {phase:1,msg:"HEAVY HITS HARDER\nBUT IS SLOWER.",hint:'PRESS NEXT TO CONTINUE',wait:false},
  /* 6 */ {phase:2,msg:"SPAR TIME!\nA TRAINER WILL ATTACK.\nBLOCK THEIR HITS!",hint:'PRESS NEXT TO START',wait:false},
  /* 7 */ {phase:2,msg:"",hint:'BLOCK - SPACE OR [F]',wait:true,need:'block',count:3},
  /* 8 */ {phase:2,msg:"YOU'RE A NATURAL!\nNOW GO FIGHT FOR REAL!",hint:'PRESS FINISH TO CLAIM YOUR REWARD',wait:false,finish:true,reward:true}
];

function tutGetStep(){return TUT_STEPS[tutStep]||null;}

function startTutorial(){
  tutMode=true;tutPhase=1;tutStep=0;
  tutJabsDone=0;tutHeaviesDone=0;tutBlocksDone=0;tutPerfectsDone=0;
  bag={x:480,hp:100,hurtFlash:0,swingAnim:0,swingDir:1};
  onlineMode=false;
  /* Launch the game wrapper */
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById('gameWrapper').classList.add('active');
  document.getElementById('onlinePingBadge').style.display='none';
  /* Setup fighters */
  p1=makeFighter(160,false,false);
  p2=null; /* no p2 in bag phase */
  particles=[];effects=[];bloodDrops=[];sweatDrops=[];
  score=[0,0];round=1;sessionTC=0;timer=30;
  document.getElementById('rndTxt').textContent='TUTORIAL';
  document.getElementById('tmr').textContent='--';
  document.getElementById('tmr').style.color='#00ffcc';
  document.getElementById('hudScr').textContent='';
  document.getElementById('hudTC').textContent='◆ '+player.tc+' TC';
  document.getElementById('p1HudName').textContent=player.name;
  document.getElementById('p2HudName').textContent='BAG';
  document.getElementById('hf1').style.width='100%';
  document.getElementById('hf2').style.width='100%';
  document.getElementById('gameOverlay').classList.remove('show');
  gameActive=true;
  /* Show tutorial overlay */
  document.getElementById('tutOverlay').style.display='flex';
  tutShowStep();
}

function tutShowStep(){
  var st=tutGetStep();
  if(!st){tutFinish();return;}
  document.getElementById('tutMsg').textContent=st.msg;
  document.getElementById('tutHint').textContent=st.hint;
  var nb=document.getElementById('tutNextBtn');
  if(!st.wait){
    nb.style.display='';
    var rewardAvail=st.reward&&!player.tutorialDone;
    nb.textContent=st.finish?(rewardAvail?'CLAIM 500 TC! ✔':'FINISH! ✔'):'NEXT ►';
    if(rewardAvail){document.getElementById('tutMsg').textContent=st.msg+'\n\n+ 500 TC REWARD!';}
    /* Show box for non-waiting steps */
    document.getElementById('tutOverlay').style.display='flex';
  }else{
    nb.style.display='none';
    document.getElementById('tutOverlay').style.display='none';
  }
  tutWaiting=st.wait;
  /* Switch phase */
  if(st.phase===2&&tutPhase===1){
    tutPhase=2;
    /* Swap to sparring: create CPU opponent who only jabs slowly */
    p2=makeFighter(500,false,false);
    p2.isCPU=false;p2.isOnlineP2=true; /* faces left like opponent */
    p2.shortCol1='#1133cc';p2.shortCol2='#001888';
    p2.gloveCol='#222222';p2.gloveShadow='#000000';
    document.getElementById('p2HudName').textContent='TRAINER';
    document.getElementById('hf2').style.width='100%';
    /* Move player to left side for spar */
    if(p1)p1.x=140;
  }
  if(st.phase===1&&p2!==null){p2=null;}
}

function tutNext(){
  var prevStep=tutStep;
  tutStep++;
  tutJabsDone=0;tutHeaviesDone=0;tutBlocksDone=0;tutPerfectsDone=0;
  /* After jab action (step 2): tutTrackAtk already showed step 3 msg, skip to step 4 (heavy action) */
  if(prevStep===2){
    tutStep=4;
    if(p1){p1.x=120;particles=[];effects=[];bag.hp=100;bag.swingAnim=0;}
  }
  /* After heavy action (step 4): tutTrackAtk showed step 5 msg, skip to step 6 (spar intro) */
  if(prevStep===4){tutStep=6;}
  /* After block action (step 7): tutTrackAtk showed final msg, skip to step 8 (finish) */
  if(prevStep===7){tutStep=8;}
  tutShowStep();
}

function tutFinish(){
  tutMode=false;tutPhase=0;
  document.getElementById('tutOverlay').style.display='none';
  gameActive=false;
  document.getElementById('gameWrapper').classList.remove('active');
  /* Award 500 TC first time only */
  if(!player.tutorialDone){
    player.tutorialDone=true;
    player.tc+=500;
    saveProfile();
  }
  showScreen('menuScreen');updateMenuUI();
}

/* Called from doAtk when in tutorial mode */
function tutTrackAtk(type,isBlock,isPerfect){
  if(!tutMode||!tutWaiting)return;
  var st=tutGetStep();if(!st||!st.need)return;
  if(st.need==='jab'&&type==='jab'){
    tutJabsDone++;
    if(tutJabsDone>=st.count){tutWaiting=false;document.getElementById('tutMsg').textContent='NICE WORK!\nNOW STEP BACK AND\nTRY 2 HEAVY PUNCHES!';document.getElementById('tutHint').textContent='PRESS NEXT WHEN READY';document.getElementById('tutOverlay').style.display='flex';document.getElementById('tutNextBtn').style.display='';addFX('GREAT!',p1.x,-100,'#00ffcc');}
    else{addFX(tutJabsDone+'/'+st.count+' JABS',p1.x,-90,'#00ffcc');}
  }
  if(st.need==='heavy'&&type==='heavy'){
    tutHeaviesDone++;
    if(tutHeaviesDone>=st.count){tutWaiting=false;document.getElementById('tutMsg').textContent='HEAVY HITS HARDER\nBUT IS SLOWER.';document.getElementById('tutHint').textContent='PRESS NEXT TO CONTINUE';document.getElementById('tutOverlay').style.display='flex';document.getElementById('tutNextBtn').style.display='';addFX('POWERFUL!',p1.x,-100,'#ff6600');}
    else{addFX(tutHeaviesDone+'/'+st.count+' HEAVY',p1.x,-90,'#ff6600');}
  }
  if(st.need==='block'&&isBlock){
    tutBlocksDone++;
    if(tutBlocksDone>=st.count){tutWaiting=false;document.getElementById('tutMsg').textContent="YOU'RE A NATURAL!\nNOW GO FIGHT FOR REAL!";document.getElementById('tutHint').textContent='PRESS FINISH TO CLAIM YOUR REWARD';document.getElementById('tutOverlay').style.display='flex';document.getElementById('tutNextBtn').style.display='';document.getElementById('tutNextBtn').textContent='CLAIM 500 TC! ✔';addFX('WELL BLOCKED!',p1.x,-100,'#00ffcc');}
    else{addFX('BLOCK '+tutBlocksDone+'/'+st.count,p1.x,-90,'#00ffcc');}
  }
  if(st.need==='perfect'&&isPerfect){
    tutPerfectsDone++;
    if(tutPerfectsDone>=st.count){tutWaiting=false;document.getElementById('tutOverlay').style.display='flex';document.getElementById('tutNextBtn').style.display='';addFX('PERFECT!!',p1.x,-100,'#ffdd00');}
  }
}

/* Draw the punching bag */
function drawBag(){
  if(!tutMode||tutPhase!==1)return;
  var bx=bag.x, ropeTop=60; /* ceiling anchor Y */
  var ropeLen=GROUND-ropeTop-100; /* length from ceiling to bag top */
  /* Dampen swing naturally */
  bag.swingAnim*=0.96;
  if(Math.abs(bag.swingAnim)<0.001)bag.swingAnim=0;
  var angle=bag.swingAnim;
  /* rope pivot at ceiling center */
  var pivotX=bx, pivotY=ropeTop;
  var bagTopX=pivotX+Math.sin(angle)*ropeLen;
  var bagTopY=pivotY+Math.cos(angle)*ropeLen;
  /* Draw rope */
  ctx.save();
  ctx.strokeStyle='#666';ctx.lineWidth=4;
  ctx.beginPath();ctx.moveTo(pivotX,pivotY);ctx.lineTo(bagTopX,bagTopY);ctx.stroke();
  /* ceiling hook */
  fr(pivotX-10,ropeTop-10,20,14,'#555');
  fr(pivotX-4,ropeTop+2,8,12,'#777');
  /* Draw bag at bottom of rope */
  ctx.save();
  ctx.translate(bagTopX,bagTopY);
  ctx.rotate(angle*0.3);
  var bw=34,bh=88;
  /* shadow */
  ctx.save();ctx.globalAlpha=0.18;ctx.fillStyle='#000';
  ctx.beginPath();ctx.ellipse(2,bh+8,18,5,0,0,Math.PI*2);ctx.fill();
  ctx.restore();
  /* bag body */
  ctx.fillStyle='#000';ctx.fillRect(-bw/2-2,0,bw+4,bh+4);
  var bagCol=bag.hurtFlash>0?'#bb4400':'#7a2d00';
  ctx.fillStyle=bagCol;ctx.fillRect(-bw/2,0,bw,bh);
  /* leather highlight */
  ctx.fillStyle='#a04000';ctx.fillRect(-bw/2+4,4,10,bh-8);
  ctx.fillStyle='rgba(255,160,60,0.08)';ctx.fillRect(-bw/2+3,3,bw-6,bh-6);
  /* stitching */
  ctx.strokeStyle='#3a1400';ctx.lineWidth=1.5;
  [bh*0.33,bh*0.66].forEach(function(sy){
    ctx.beginPath();ctx.moveTo(-bw/2+2,sy);ctx.lineTo(bw/2-2,sy);ctx.stroke();
  });
  ctx.beginPath();ctx.moveTo(0,2);ctx.lineTo(0,bh-2);ctx.stroke();
  /* top/bottom caps */
  ctx.fillStyle='#4a1800';ctx.fillRect(-bw/2,0,bw,10);ctx.fillRect(-bw/2,bh-8,bw,8);
  /* Lace */
  ctx.fillStyle='#eecc88';
  for(var li=0;li<4;li++) ctx.fillRect(-3,12+li*20,6,3);
  /* HP bar below bag */
  var bpct=bag.hp/100;
  ctx.fillStyle='#111';ctx.fillRect(-bw/2,bh+6,bw,7);
  ctx.fillStyle='#333';ctx.fillRect(-bw/2+1,bh+7,bw-2,5);
  ctx.fillStyle=bpct>0.5?'#00cc55':bpct>0.25?'#ffaa00':'#ff2244';
  ctx.fillRect(-bw/2+1,bh+7,Math.floor((bw-2)*bpct),5);
  /* HP label */
  ctx.font='5px "Press Start 2P"';ctx.fillStyle='#aaa';ctx.textAlign='center';
  ctx.fillText('BAG HP',0,bh+22);ctx.textAlign='left';
  ctx.restore();/* bag local */

  /* "WALK CLOSER" arrow if too far */
  var dist=p1?Math.abs(p1.x-bag.x):999;
  var canReach=(dist<=130);
  if(!canReach){
    ctx.save();ctx.globalAlpha=0.7+Math.sin(Date.now()*0.008)*0.3;
    ctx.fillStyle='#00ffcc';ctx.font='6px "Press Start 2P"';ctx.textAlign='center';
    var arrowX=bag.x>320?bag.x-50:bag.x+50;
    ctx.fillText(bag.x>p1.x?'>>':'<<',arrowX,bagTopY-10);
    ctx.restore();ctx.textAlign='left';
  }
  ctx.restore();/* global save */
  if(bag.hurtFlash>0)bag.hurtFlash--;
}

/* Bag hit logic (replaces doAtk for tutorial phase 1) */
function doBagAtk(type){
  if(!p1)return;
  /* Must be close enough to the bag */
  if(Math.abs(p1.x-bag.x)>130){addFX('TOO FAR!',p1.x,-60,'#ff4444');return;}
  if(type==='jab'&&p1.jabCD>0)return;
  if(type==='heavy'&&p1.heavyCD>0){addFX('COOLING!',p1.x,-60,'#888');return;}
  if(p1.stamina<8){addFX('NO STAM!',p1.x,-60,'#666');return;}
  var jabFrames=16,hvyFrames=52;
  p1.leadHand=1-p1.leadHand;
  p1.state=type;p1.stateTimer=type==='jab'?jabFrames:hvyFrames;
  p1.punchT=p1.stateTimer;p1.punchTMax=p1.stateTimer;
  p1.punchCD=p1.stateTimer;
  if(type==='jab')p1.jabCD=JAB_CD;
  if(type==='heavy')p1.heavyCD=HEAVY_CD;
  p1.stamina=Math.max(0,p1.stamina-(type==='jab'?18:38));
  var dmg=type==='jab'?6:14;
  bag.hp=Math.max(0,bag.hp-dmg);
  bag.hurtFlash=10;
  /* swing handled in doBagAtk above */
  effects=[]; /* clear old hit text before showing new one */
  burst(bag.x,GROUND-80,type==='heavy'?'#ff4400':'#ffcc00',type==='heavy'?12:5);
  sweatBurst(bag.x,GROUND-80,3);
  /* Gentle swing on bag hit - no screen shake */
  bag.swingAnim+=(type==='heavy'?0.22:0.09)*(p1.x<bag.x?1:-1);
  bag.swingAnim=Math.max(-0.35,Math.min(0.35,bag.swingAnim));
  addFX(type==='heavy'?'BOOM!':'JAB!',bag.x,-75,'#ffdd00');
  tutTrackAtk(type,false,false);
  if(bag.hp<=0){
    bag.hp=100; /* reset bag */
    burst(bag.x,GROUND-60,'#ffdd00',20);
    addFX('BAG DESTROYED!',bag.x,-110,'#ffdd00');
  }
}

/* Trainer AI for spar phase - attacks slowly so player can practice blocking */
var trainerCD=0,trainerAttackCount=0;
function updateTrainer(){
  if(!p2||!p1||!gameActive||tutPhase!==2)return;
  /* Trainer just stands still and jabs periodically */
  p2.walkDir=0;p2.blocking=false;
  if(trainerCD>0){trainerCD--;return;}
  /* Only attack during the block/perfect block steps */
  var st=tutGetStep();
  if(!st||!st.need||st.need!=='block')return;
  trainerCD=90; /* attack every 1.5 seconds */
  /* Slow jab toward player */
  doAtk(p2,p1,'jab');
}

/* Hook into doAtk to track tutorial blocks */
var _origDoAtk=doAtk;

/* ── GLOBAL G ── */
var G={
  doLogin:doLogin,doSignup:doSignup,doLogout:doLogout,doGuest:doGuest,switchTab:switchTab,
  showScreen:showScreen,goToGame:goToGame,goToMenu:goToMenu,
  saveName:saveName,
  renderShop:renderShop,
  renderInventory:renderInventory,switchInvTab:switchInvTab,
  showOnlineLobby:showOnlineLobby,createRoom:createRoom,joinRoom:joinRoom,leaveOnline:leaveOnline,
  updateMenuUI:updateMenuUI,player:player,
  startTutorial:startTutorial,tutNext:tutNext
};

document.getElementById('loginBtn').addEventListener('click',function(){G.doLogin();});
document.getElementById('signupBtn').addEventListener('click',function(){G.doSignup();});
document.getElementById('guestBtn').addEventListener('click',function(){G.doGuest();});
</script>
</body>
</html>
